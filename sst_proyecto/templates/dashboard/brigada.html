{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard Brigada - Sistema SST{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Dashboard Brigada de Emergencia</li>
{% endblock %}

{% block content %}
<!-- Seccion 1: Header + Estado del Brigadista -->
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-3">
    <div>
        <h1 class="h3 fw-bold text-dark mb-1">
            <i class="bi bi-shield-fill-exclamation text-danger me-2"></i>
            Brigada de Emergencia
        </h1>
        <p class="text-muted mb-0">
            {{ user.get_full_name|default:user.username }}
            <span id="lastUpdateIndicator" class="ms-3 badge bg-light text-secondary">
                <i class="bi bi-arrow-repeat me-1"></i>Cargando...
            </span>
        </p>
    </div>
    <div class="d-flex align-items-center gap-2 flex-shrink-0 flex-wrap">
        <!-- Toggle de Disponibilidad -->
        <div id="toggleDisponibilidad" class="d-flex align-items-center border rounded-pill px-3 py-2">
            <span class="me-2 small fw-bold" id="textoDisponibilidad">Cargando...</span>
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" role="switch" id="switchDisponible" onchange="toggleDisponibilidad()" style="cursor:pointer; width:3rem; height:1.5rem;">
            </div>
        </div>
        <button class="btn btn-outline-secondary btn-sm" onclick="refrescarTodo()" title="Actualizar ahora">
            <i class="bi bi-arrow-clockwise"></i>
        </button>
    </div>
</div>

<!-- Seccion 2: Metricas (4 cards) -->
<div class="row g-3 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card card-modern border-0 border-start border-4 border-danger">
            <div class="card-body p-3">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-1 small">Emergencias Activas</h6>
                        <h3 class="fw-bold mb-0" id="metricaActivas">
                            <span class="spinner-border spinner-border-sm"></span>
                        </h3>
                    </div>
                    <div class="rounded-3 p-2 bg-danger bg-opacity-10">
                        <i class="bi bi-exclamation-triangle-fill fs-4 text-danger"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card card-modern border-0 border-start border-4 border-warning">
            <div class="card-body p-3">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-1 small">Brigadistas Disponibles</h6>
                        <h3 class="fw-bold mb-0" id="metricaBrigadistas">
                            <span class="spinner-border spinner-border-sm"></span>
                        </h3>
                    </div>
                    <div class="rounded-3 p-2 bg-warning bg-opacity-10">
                        <i class="bi bi-people-fill fs-4 text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card card-modern border-0 border-start border-4 border-info">
            <div class="card-body p-3">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-1 small">Tiempo Promedio Resp.</h6>
                        <h3 class="fw-bold mb-0" id="metricaTiempo">-- min</h3>
                    </div>
                    <div class="rounded-3 p-2 bg-info bg-opacity-10">
                        <i class="bi bi-stopwatch fs-4 text-info"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% include 'components/metric-card.html' with label="Incidentes del Mes" value=incidentes_total_mes|default:0 sublabel=incidentes_pendientes|default:0|add:" pendientes" sublabel_icon="bi bi-exclamation-circle" sublabel_color="warning" icon="bi-clipboard-data" icon_color="primary" border_color="primary" %}
</div>

<!-- Seccion 3: Emergencias Activas + Mapa -->
<div class="row g-4 mb-4">
    <!-- Emergencias Activas -->
    <div class="col-lg-7">
        <div class="card card-modern">
            <div class="card-header-modern d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-exclamation-octagon-fill text-danger me-2"></i>
                    Emergencias Activas
                    <span class="badge bg-danger ms-1" id="badgeActivas" style="display:none;">0</span>
                </h6>
                <div class="d-flex gap-2">
                    <button class="btn btn-danger btn-sm" onclick="mostrarModalEmergencia()">
                        <i class="bi bi-megaphone-fill me-1"></i>Reportar
                    </button>
                    <a href="/emergencias/" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-list-ul me-1"></i>Ver Todas
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="listaEmergenciasActivas" class="p-3">
                    <div class="text-center py-4 text-muted">
                        <div class="spinner-border spinner-border-sm me-2"></div>Cargando emergencias...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mapa -->
    <div class="col-lg-5">
        <div class="card card-modern">
            <div class="card-header-modern d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-geo-alt-fill me-2"></i>Mapa
                </h6>
                <a href="/mapas/" class="btn btn-sm btn-outline-primary">Mapa Completo</a>
            </div>
            <div class="card-body p-0">
                <div id="evacuationMap" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Seccion 4: Equipo de Brigada (colapsable) -->
<div class="card card-modern mb-4">
    <div class="card-header-modern d-flex justify-content-between align-items-center" style="cursor:pointer;" data-bs-toggle="collapse" data-bs-target="#collapseBrigadistas">
        <h6 class="mb-0">
            <i class="bi bi-people-fill me-2"></i>
            Equipo de Brigada
            <span class="badge bg-success ms-1" id="badgeBrigadistasDisp">0</span>
            <small class="text-muted ms-1">disponibles</small>
        </h6>
        <i class="bi bi-chevron-down"></i>
    </div>
    <div class="collapse" id="collapseBrigadistas">
        <div class="card-body">
            <div class="row" id="listaBrigadistas">
                <div class="text-center py-3 text-muted">
                    <div class="spinner-border spinner-border-sm me-2"></div>Cargando...
                </div>
            </div>
            <a href="{% url 'mi_brigada' %}" class="btn btn-sm btn-outline-secondary mt-2">
                <i class="bi bi-people me-1"></i>Ver todos los brigadistas
            </a>
        </div>
    </div>
</div>

<!-- Seccion 5: Incidentes Reportados (colapsable) -->
<div class="card card-modern mb-4">
    <div class="card-header-modern d-flex justify-content-between align-items-center" style="cursor:pointer;" data-bs-toggle="collapse" data-bs-target="#collapseIncidentes">
        <h6 class="mb-0">
            <i class="bi bi-exclamation-triangle-fill me-2 text-warning"></i>
            Incidentes Reportados
            {% if incidentes_pendientes %}
            <span class="badge bg-danger ms-2">{{ incidentes_pendientes }}</span>
            {% endif %}
        </h6>
        <div class="d-flex align-items-center gap-2">
            <a href="{% url 'listar_incidentes' %}" class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation();">
                <i class="bi bi-list-ul me-1"></i>Ver Todos
            </a>
            <i class="bi bi-chevron-down"></i>
        </div>
    </div>
    <div class="collapse" id="collapseIncidentes">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Incidente</th>
                            <th>Gravedad</th>
                            <th>Estado</th>
                            <th>Reportado por</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for incidente in incidentes_recientes %}
                        <tr>
                            <td class="ps-4">
                                <div class="fw-bold">{{ incidente.titulo }}</div>
                                <small class="text-muted">{{ incidente.ubicacion }}</small>
                            </td>
                            <td>
                                {% if incidente.gravedad == 'CRITICA' %}
                                    <span class="badge bg-danger">Critica</span>
                                {% elif incidente.gravedad == 'ALTA' %}
                                    <span class="badge bg-warning text-dark">Alta</span>
                                {% elif incidente.gravedad == 'MEDIA' %}
                                    <span class="badge bg-info">Media</span>
                                {% else %}
                                    <span class="badge bg-success">Baja</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if incidente.estado == 'REPORTADO' %}
                                    <span class="badge bg-warning text-dark">Reportado</span>
                                {% elif incidente.estado == 'EN_REVISION' or incidente.estado == 'EN_PROCESO' %}
                                    <span class="badge bg-info">En Proceso</span>
                                {% elif incidente.estado == 'RESUELTO' %}
                                    <span class="badge bg-success">Resuelto</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ incidente.get_estado_display }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <div>{{ incidente.reportado_por.get_full_name|default:incidente.reportado_por.username }}</div>
                                <small class="text-muted">{{ incidente.reportado_por.get_rol_display }}</small>
                            </td>
                            <td>
                                <small>{{ incidente.fecha_reporte|date:"d/m/Y" }}</small><br>
                                <small class="text-muted">{{ incidente.fecha_reporte|time:"h:i A" }}</small>
                            </td>
                            <td>
                                <a href="{% url 'detalle_incidente' incidente.id %}" class="btn btn-sm btn-outline-primary" title="Ver detalle">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">
                                <i class="bi bi-check-circle fs-4 d-block mb-2"></i>
                                No hay incidentes reportados.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Seccion 6: Historial + Estadisticas (colapsable) -->
<div class="row g-4 mb-4">
    <div class="col-lg-8">
        <div class="card card-modern">
            <div class="card-header-modern d-flex justify-content-between align-items-center" style="cursor:pointer;" data-bs-toggle="collapse" data-bs-target="#collapseHistorial">
                <h6 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>Historial Reciente
                </h6>
                <i class="bi bi-chevron-down"></i>
            </div>
            <div class="collapse" id="collapseHistorial">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-3">Tipo</th>
                                    <th>Ubicacion</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                    <th>Resolucion</th>
                                </tr>
                            </thead>
                            <tbody id="tablaHistorial">
                                <tr><td colspan="5" class="text-center py-3 text-muted">
                                    <div class="spinner-border spinner-border-sm me-2"></div>Cargando...
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card card-modern">
            <div class="card-header-modern d-flex justify-content-between align-items-center" style="cursor:pointer;" data-bs-toggle="collapse" data-bs-target="#collapseStats">
                <h6 class="mb-0">
                    <i class="bi bi-graph-up me-2"></i>Estadisticas del Mes
                </h6>
                <i class="bi bi-chevron-down"></i>
            </div>
            <div class="collapse" id="collapseStats">
                <div class="card-body" id="statsEmergencias">
                    <div class="text-center py-3 text-muted">
                        <div class="spinner-border spinner-border-sm me-2"></div>Cargando...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Seccion 7: Equipamiento (colapsable) -->
<div class="card card-modern mb-4">
    <div class="card-header-modern d-flex justify-content-between align-items-center" style="cursor:pointer;" data-bs-toggle="collapse" data-bs-target="#collapseEquipos">
        <h6 class="mb-0">
            <i class="bi bi-tools me-2"></i>Estado de Equipos
        </h6>
        <div class="d-flex align-items-center gap-2">
            <a href="{% url 'equipos_brigada' %}" class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation();">Ver todos</a>
            <i class="bi bi-chevron-down"></i>
        </div>
    </div>
    <div class="collapse" id="collapseEquipos">
        <div class="card-body" id="estadoEquipos">
            <div class="text-center py-3 text-muted">
                <div class="spinner-border spinner-border-sm me-2"></div>Cargando...
            </div>
        </div>
    </div>
</div>

<!-- Modal: Reportar Emergencia -->
<div class="modal fade" id="modalEmergencia" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Reportar Emergencia
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Atencion:</strong> Esta accion activara una alerta y notificara a todo el personal de brigada.
                </div>
                <form id="formEmergencia">
                    <div class="mb-3">
                        <label for="tipoEmergencia" class="form-label fw-bold">Tipo de Emergencia *</label>
                        <select class="form-select" id="tipoEmergencia" required>
                            <option value="">Seleccione el tipo...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="descripcionEmergencia" class="form-label fw-bold">Descripcion *</label>
                        <textarea class="form-control" id="descripcionEmergencia" rows="3" placeholder="Describa brevemente la situacion..." required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="ubicacionEmergencia" class="form-label fw-bold">Ubicacion</label>
                            <input type="text" class="form-control" id="ubicacionEmergencia" placeholder="Ej: Bloque A, segundo piso">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="personasAfectadas" class="form-label fw-bold">Personas afectadas</label>
                            <input type="number" class="form-control" id="personasAfectadas" value="0" min="0">
                        </div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="requiereEvacuacion">
                        <label class="form-check-label fw-bold text-danger" for="requiereEvacuacion">
                            <i class="bi bi-sign-stop-fill me-1"></i>Requiere evacuacion inmediata
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmarEmergencia()" id="btnConfirmarEmergencia">
                    <i class="bi bi-megaphone-fill me-2"></i>CONFIRMAR EMERGENCIA
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Resolver Emergencia -->
<div class="modal fade" id="modalResolver" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-check-circle me-2"></i>Resolver Emergencia</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="accionesTomadas" class="form-label fw-bold">Acciones tomadas</label>
                    <textarea class="form-control" id="accionesTomadas" rows="3" placeholder="Describa las acciones que se tomaron para resolver la emergencia..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnConfirmarResolver">
                    <i class="bi bi-check-circle me-1"></i>Confirmar Resolucion
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Falsa Alarma -->
<div class="modal fade" id="modalFalsaAlarma" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title"><i class="bi bi-x-circle me-2"></i>Marcar Falsa Alarma</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-info-circle me-2"></i>Se notificara al usuario que reporto esta emergencia.
                </div>
                <div class="mb-3">
                    <label for="motivoFalsa" class="form-label fw-bold">Motivo *</label>
                    <textarea class="form-control" id="motivoFalsa" rows="3" placeholder="Explique por que se considera falsa alarma..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarFalsa">
                    <i class="bi bi-x-circle me-1"></i>Confirmar Falsa Alarma
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast de Feedback -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
    <div id="toastFeedback" class="toast align-items-center border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="toastMensaje"></div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// === UTILIDADES ===
function getCookie(name) {
    let v = null;
    document.cookie.split(';').forEach(c => {
        c = c.trim();
        if (c.startsWith(name + '=')) v = decodeURIComponent(c.substring(name.length + 1));
    });
    return v;
}

function mostrarToast(mensaje, tipo = 'success') {
    const toast = document.getElementById('toastFeedback');
    const body = document.getElementById('toastMensaje');
    toast.className = `toast align-items-center border-0 text-white bg-${tipo}`;
    body.textContent = mensaje;
    new bootstrap.Toast(toast, { delay: 3000 }).show();
}

function tiempoRelativo(fechaStr) {
    const diff = Math.floor((new Date() - new Date(fechaStr)) / 60000);
    if (diff < 1) return 'ahora';
    if (diff < 60) return `hace ${diff} min`;
    if (diff < 1440) return `hace ${Math.floor(diff / 60)}h`;
    return `hace ${Math.floor(diff / 1440)}d`;
}

// === VARIABLES GLOBALES ===
let modalEmergencia, modalResolver, modalFalsaAlarma;
let emergenciaResolviendoId = null;
let emergenciaFalsaId = null;
let markersEmergencias = [];

// === MAPA ===
const map = L.map('evacuationMap').setView([5.7303596, -72.8943613], 17);
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Esri'
}).addTo(map);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
    pane: 'overlayPane'
}).addTo(map);

const puntoEncuentroIcon = L.divIcon({
    className: 'custom-div-icon',
    html: '<div style="background:#4CAF50;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,.3);font-size:11px;">PE</div>',
    iconSize: [30, 30]
});

const emergenciaIcon = L.divIcon({
    className: 'custom-div-icon',
    html: '<div style="background:#dc3545;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;border:2px solid white;box-shadow:0 2px 6px rgba(220,53,69,.5);animation:pulseMarker 1.5s infinite;"><i class="bi bi-exclamation-triangle-fill" style="font-size:14px;"></i></div>',
    iconSize: [30, 30]
});

// Cargar puntos de encuentro
fetch('/api/mapas/api/puntos-encuentro/')
    .then(r => r.json())
    .then(data => {
        (data.results || data).forEach(p => {
            L.marker([p.latitud, p.longitud], {icon: puntoEncuentroIcon}).addTo(map)
                .bindPopup(`<b>${p.nombre}</b><br>${p.descripcion || ''}<br>Capacidad: ${p.capacidad || '-'}`);
        });
    }).catch(() => {});

// === DISPONIBILIDAD DEL BRIGADISTA ===
async function cargarDisponibilidad() {
    try {
        const r = await fetch('/api/emergencias/brigada/mi-disponibilidad/');
        if (!r.ok) {
            document.getElementById('toggleDisponibilidad').style.display = 'none';
            return;
        }
        const data = await r.json();
        const sw = document.getElementById('switchDisponible');
        const txt = document.getElementById('textoDisponibilidad');
        const container = document.getElementById('toggleDisponibilidad');
        sw.checked = data.disponible;
        txt.textContent = data.disponible ? 'Disponible' : 'No disponible';
        txt.className = `me-2 small fw-bold text-${data.disponible ? 'success' : 'secondary'}`;
        container.className = `d-flex align-items-center border rounded-pill px-3 py-2 border-${data.disponible ? 'success' : 'secondary'}`;
    } catch(e) {
        document.getElementById('toggleDisponibilidad').style.display = 'none';
    }
}

async function toggleDisponibilidad() {
    const sw = document.getElementById('switchDisponible');
    try {
        const r = await fetch('/api/emergencias/brigada/mi-disponibilidad/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ disponible: sw.checked })
        });
        if (r.ok) {
            const data = await r.json();
            const txt = document.getElementById('textoDisponibilidad');
            const container = document.getElementById('toggleDisponibilidad');
            txt.textContent = data.disponible ? 'Disponible' : 'No disponible';
            txt.className = `me-2 small fw-bold text-${data.disponible ? 'success' : 'secondary'}`;
            container.className = `d-flex align-items-center border rounded-pill px-3 py-2 border-${data.disponible ? 'success' : 'secondary'}`;
            mostrarToast(data.mensaje, 'success');
            cargarBrigadistas();
        } else {
            sw.checked = !sw.checked;
            mostrarToast('Error al cambiar disponibilidad', 'danger');
        }
    } catch(e) {
        sw.checked = !sw.checked;
        mostrarToast('Error de conexion', 'danger');
    }
}

// === EMERGENCIAS ===
async function cargarEmergencias() {
    try {
        const r = await fetch('/api/emergencias/emergencias/');
        const data = await r.json();
        const lista = data.results || data;

        const activas = lista.filter(e => e.estado === 'REPORTADA' || e.estado === 'EN_ATENCION');
        const resueltas = lista.filter(e => e.estado !== 'REPORTADA' && e.estado !== 'EN_ATENCION');

        // Actualizar metricas
        document.getElementById('metricaActivas').textContent = activas.length;
        const badgeActivas = document.getElementById('badgeActivas');
        badgeActivas.textContent = activas.length;
        badgeActivas.style.display = activas.length > 0 ? 'inline' : 'none';

        // Renderizar emergencias activas como tarjetas
        const cont = document.getElementById('listaEmergenciasActivas');
        if (!activas.length) {
            cont.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-check-circle fs-1 d-block mb-2 text-success"></i>
                    <strong>Sin emergencias activas</strong>
                    <p class="small mb-0">El sistema esta operando normalmente</p>
                </div>`;
        } else {
            const estadoBadge = { REPORTADA: 'warning', EN_ATENCION: 'info' };
            const estadoTexto = { REPORTADA: 'Reportada', EN_ATENCION: 'En Atencion' };
            cont.innerHTML = activas.map(e => `
                <div class="border rounded-3 p-3 mb-3 border-start border-4 border-${estadoBadge[e.estado]} bg-${estadoBadge[e.estado]} bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <strong>${e.tipo_nombre || 'Emergencia'}</strong>
                            <span class="badge bg-${estadoBadge[e.estado]} ms-2">${estadoTexto[e.estado]}</span>
                        </div>
                        <small class="text-muted">${tiempoRelativo(e.fecha_hora_reporte)}</small>
                    </div>
                    <p class="mb-2 small text-dark">${e.descripcion || ''}</p>
                    <div class="d-flex flex-wrap gap-2 mb-2 small text-muted">
                        ${e.descripcion_ubicacion ? `<span><i class="bi bi-geo-alt me-1"></i>${e.descripcion_ubicacion}</span>` : ''}
                        ${e.personas_afectadas ? `<span><i class="bi bi-people me-1"></i>${e.personas_afectadas} afectados</span>` : ''}
                        ${e.requiere_evacuacion ? `<span class="text-danger fw-bold"><i class="bi bi-sign-stop-fill me-1"></i>Evacuacion</span>` : ''}
                        ${e.reportada_por_detalle ? `<span><i class="bi bi-person me-1"></i>${e.reportada_por_detalle.first_name || ''} ${e.reportada_por_detalle.last_name || ''}</span>` : ''}
                    </div>
                    <div class="d-flex gap-2">
                        ${e.estado === 'REPORTADA' ? `
                            <button class="btn btn-info btn-sm" onclick="atenderEmergencia(${e.id})">
                                <i class="bi bi-person-check me-1"></i>Atender
                            </button>` : ''}
                        <button class="btn btn-success btn-sm" onclick="iniciarResolucion(${e.id})">
                            <i class="bi bi-check-circle me-1"></i>Resolver
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="iniciarFalsaAlarma(${e.id})">
                            <i class="bi bi-x-circle me-1"></i>Falsa Alarma
                        </button>
                    </div>
                </div>`).join('');
        }

        // Actualizar marcadores de emergencias en el mapa
        markersEmergencias.forEach(m => map.removeLayer(m));
        markersEmergencias = [];
        activas.forEach(e => {
            if (e.latitud && e.longitud) {
                const marker = L.marker([e.latitud, e.longitud], {icon: emergenciaIcon}).addTo(map)
                    .bindPopup(`<b>${e.tipo_nombre || 'Emergencia'}</b><br>${e.descripcion_ubicacion || ''}<br><span class="badge bg-danger">${e.estado}</span>`);
                markersEmergencias.push(marker);
            }
        });

        // Historial (resueltas, max 10)
        const historial = resueltas.slice(0, 10);
        const tbody = document.getElementById('tablaHistorial');
        const estadoColor = { CONTROLADA: 'primary', RESUELTA: 'success', FALSA_ALARMA: 'secondary' };
        const estadoNombre = { CONTROLADA: 'Controlada', RESUELTA: 'Resuelta', FALSA_ALARMA: 'Falsa Alarma' };
        if (!historial.length) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-3 text-muted">Sin historial</td></tr>';
        } else {
            tbody.innerHTML = historial.map(e => {
                let resolucion = '--';
                if (e.fecha_hora_resolucion) {
                    const mins = Math.floor((new Date(e.fecha_hora_resolucion) - new Date(e.fecha_hora_reporte)) / 60000);
                    resolucion = mins < 60 ? `${mins} min` : `${Math.floor(mins/60)}h ${mins%60}m`;
                }
                return `
                <tr class="${e.estado === 'FALSA_ALARMA' ? 'table-danger' : ''}">
                    <td class="ps-3"><strong>${e.tipo_nombre || 'Emergencia'}</strong></td>
                    <td>${e.descripcion_ubicacion || '-'}</td>
                    <td><span class="badge bg-${estadoColor[e.estado] || 'secondary'}">${estadoNombre[e.estado] || e.estado}</span></td>
                    <td><small>${new Date(e.fecha_hora_reporte).toLocaleDateString('es-CO', {day:'2-digit',month:'2-digit',year:'2-digit'})}</small></td>
                    <td><small>${resolucion}</small></td>
                </tr>`;
            }).join('');
        }

        // Estadisticas del mes
        calcularEstadisticas(lista);
    } catch(e) {
        document.getElementById('listaEmergenciasActivas').innerHTML = '<div class="text-center py-3 text-danger"><i class="bi bi-exclamation-circle me-2"></i>Error al cargar emergencias</div>';
    }
}

function calcularEstadisticas(lista) {
    const ahora = new Date();
    const inicioMes = new Date(ahora.getFullYear(), ahora.getMonth(), 1);
    const mes = lista.filter(e => new Date(e.fecha_hora_reporte) >= inicioMes);

    const stats = { activas: 0, resueltas: 0, falsas: 0 };
    mes.forEach(e => {
        if (e.estado === 'REPORTADA' || e.estado === 'EN_ATENCION') stats.activas++;
        else if (e.estado === 'RESUELTA' || e.estado === 'CONTROLADA') stats.resueltas++;
        else if (e.estado === 'FALSA_ALARMA') stats.falsas++;
    });

    const cont = document.getElementById('statsEmergencias');
    const tasa = mes.length > 0 ? Math.round((stats.resueltas / mes.length) * 100) : 0;
    cont.innerHTML = `
        <div class="row text-center g-2 mb-3">
            <div class="col-4">
                <div class="p-2 bg-danger bg-opacity-10 rounded">
                    <h4 class="text-danger mb-0">${stats.activas}</h4>
                    <small class="text-muted">Activas</small>
                </div>
            </div>
            <div class="col-4">
                <div class="p-2 bg-success bg-opacity-10 rounded">
                    <h4 class="text-success mb-0">${stats.resueltas}</h4>
                    <small class="text-muted">Resueltas</small>
                </div>
            </div>
            <div class="col-4">
                <div class="p-2 bg-secondary bg-opacity-10 rounded">
                    <h4 class="text-secondary mb-0">${stats.falsas}</h4>
                    <small class="text-muted">Falsas</small>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-1">
            <small class="text-muted">Tasa de resolucion</small>
            <strong>${tasa}%</strong>
        </div>
        <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-success" style="width: ${tasa}%"></div>
        </div>
        <div class="text-center mt-2">
            <small class="text-muted">Total del mes: ${mes.length}</small>
        </div>`;

    // Tiempo promedio
    const resueltas = lista.filter(e => e.estado === 'RESUELTA' && e.fecha_hora_resolucion);
    if (resueltas.length > 0) {
        let total = 0;
        resueltas.forEach(e => {
            total += (new Date(e.fecha_hora_resolucion) - new Date(e.fecha_hora_reporte)) / 60000;
        });
        document.getElementById('metricaTiempo').textContent = `${Math.round(total / resueltas.length)} min`;
    }
}

// === ACCIONES DE EMERGENCIA ===
async function atenderEmergencia(id) {
    if (!confirm('Confirmar que esta atendiendo esta emergencia?')) return;
    try {
        const r = await fetch(`/api/emergencias/emergencias/${id}/atender/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }
        });
        if (r.ok) {
            mostrarToast('Emergencia marcada como en atencion', 'info');
            cargarEmergencias();
        } else {
            const err = await r.json();
            mostrarToast(err.error || 'Error al atender emergencia', 'danger');
        }
    } catch(e) {
        mostrarToast('Error de conexion', 'danger');
    }
}

function iniciarResolucion(id) {
    emergenciaResolviendoId = id;
    document.getElementById('accionesTomadas').value = '';
    modalResolver.show();
}

function iniciarFalsaAlarma(id) {
    emergenciaFalsaId = id;
    document.getElementById('motivoFalsa').value = '';
    modalFalsaAlarma.show();
}

async function resolverEmergencia() {
    const acciones = document.getElementById('accionesTomadas').value;
    const btn = document.getElementById('btnConfirmarResolver');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Procesando...';
    try {
        const r = await fetch(`/api/emergencias/emergencias/${emergenciaResolviendoId}/resolver/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ acciones_tomadas: acciones })
        });
        if (r.ok) {
            modalResolver.hide();
            mostrarToast('Emergencia resuelta exitosamente', 'success');
            cargarEmergencias();
        } else {
            const err = await r.json();
            mostrarToast(err.error || 'Error al resolver', 'danger');
        }
    } catch(e) {
        mostrarToast('Error de conexion', 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Confirmar Resolucion';
    }
}

async function marcarFalsaAlarma() {
    const motivo = document.getElementById('motivoFalsa').value.trim();
    if (!motivo) {
        mostrarToast('Debe proporcionar un motivo', 'warning');
        return;
    }
    const btn = document.getElementById('btnConfirmarFalsa');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Procesando...';
    try {
        const r = await fetch(`/api/emergencias/emergencias/${emergenciaFalsaId}/marcar-falsa-alarma/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ motivo: motivo })
        });
        if (r.ok) {
            modalFalsaAlarma.hide();
            const data = await r.json();
            mostrarToast(data.mensaje || 'Marcada como falsa alarma', 'warning');
            cargarEmergencias();
        } else {
            const err = await r.json();
            mostrarToast(err.error || 'Error', 'danger');
        }
    } catch(e) {
        mostrarToast('Error de conexion', 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-x-circle me-1"></i>Confirmar Falsa Alarma';
    }
}

// === BRIGADISTAS ===
async function cargarBrigadistas() {
    try {
        const r = await fetch('/api/emergencias/brigada/');
        const data = await r.json();
        const lista = data.results || data;
        const cont = document.getElementById('listaBrigadistas');
        const badge = document.getElementById('badgeBrigadistasDisp');

        const disponibles = lista.filter(b => b.disponible && b.activo);
        badge.textContent = disponibles.length;
        document.getElementById('metricaBrigadistas').textContent = `${disponibles.length}/${lista.length}`;

        if (!lista.length) {
            cont.innerHTML = '<p class="text-center text-muted py-3">No hay brigadistas registrados</p>';
            return;
        }

        const espNames = {PRIMEROS_AUXILIOS:'Primeros Auxilios', INCENDIOS:'Incendios', EVACUACION:'Evacuacion', RESCATE:'Rescate', COMUNICACIONES:'Comunicaciones', GENERAL:'General'};
        cont.innerHTML = '<div class="row g-2">' + lista.map(b => {
            const color = b.disponible ? 'success' : 'secondary';
            const icon = b.disponible ? 'bi-person-check-fill' : 'bi-person-x-fill';
            return `
                <div class="col-md-6 col-lg-4">
                    <div class="d-flex align-items-center p-2 border rounded">
                        <div class="rounded-circle bg-${color} bg-opacity-10 text-${color} me-2 d-flex align-items-center justify-content-center" style="width:35px;height:35px;min-width:35px;">
                            <i class="bi ${icon}"></i>
                        </div>
                        <div class="overflow-hidden">
                            <div class="fw-bold small text-truncate">${b.usuario_nombre || 'Brigadista'}</div>
                            <small class="text-muted">${espNames[b.especializacion] || b.especializacion}</small>
                        </div>
                    </div>
                </div>`;
        }).join('') + '</div>';
    } catch(e) {
        document.getElementById('listaBrigadistas').innerHTML = '<p class="text-center text-danger py-3">Error al cargar</p>';
    }
}

// === EQUIPOS ===
async function cargarEstadoEquipos() {
    try {
        const r = await fetch('/api/mapas/api/equipamientos/');
        const data = await r.json();
        const lista = data.results || data;
        const cont = document.getElementById('estadoEquipos');

        const porTipo = {};
        lista.forEach(e => {
            if (!porTipo[e.tipo]) porTipo[e.tipo] = { total: 0, operativos: 0 };
            porTipo[e.tipo].total++;
            if (e.estado === 'OPERATIVO') porTipo[e.tipo].operativos++;
        });

        const iconos = { EXTINTOR:'bi-fire text-danger', BOTIQUIN:'bi-heart-pulse text-success', CAMILLA:'bi-hospital text-primary', DESFIBRILADOR:'bi-lightning-charge text-warning', HIDRANTE:'bi-droplet-fill text-info', ALARMA:'bi-bell text-warning', SENALIZACION:'bi-signpost text-secondary' };
        const nombres = { EXTINTOR:'Extintores', BOTIQUIN:'Botiquines', CAMILLA:'Camillas', DESFIBRILADOR:'Desfibriladores', HIDRANTE:'Hidrantes', ALARMA:'Alarmas', SENALIZACION:'Senalizacion' };

        if (Object.keys(porTipo).length === 0) {
            cont.innerHTML = '<p class="text-center text-muted py-2">Sin equipos registrados</p>';
            return;
        }

        cont.innerHTML = Object.entries(porTipo).map(([tipo, info]) => {
            const pct = Math.round((info.operativos / info.total) * 100);
            const colorBar = pct >= 100 ? 'success' : pct >= 70 ? 'warning' : 'danger';
            return `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="small"><i class="bi ${iconos[tipo] || 'bi-tools text-secondary'} me-1"></i>${nombres[tipo] || tipo}</span>
                        <span class="badge bg-${colorBar}">${info.operativos}/${info.total}</span>
                    </div>
                    <div class="progress" style="height: 5px;">
                        <div class="progress-bar bg-${colorBar}" style="width: ${pct}%"></div>
                    </div>
                </div>`;
        }).join('');
    } catch(e) {
        document.getElementById('estadoEquipos').innerHTML = '<p class="text-center text-danger py-2">Error al cargar</p>';
    }
}

// === TIPOS DE EMERGENCIA (para modal) ===
async function cargarTiposEmergencia() {
    try {
        const r = await fetch('/api/emergencias/tipos/');
        const data = await r.json();
        const select = document.getElementById('tipoEmergencia');
        (data.results || data).forEach(tipo => {
            const opt = document.createElement('option');
            opt.value = tipo.id;
            opt.textContent = `${tipo.nombre} (${tipo.prioridad_display || tipo.prioridad})`;
            select.appendChild(opt);
        });
    } catch(e) { console.error('Error cargando tipos:', e); }
}

// === CREAR EMERGENCIA ===
function mostrarModalEmergencia() {
    modalEmergencia.show();
}

async function confirmarEmergencia() {
    const tipo = document.getElementById('tipoEmergencia').value;
    const descripcion = document.getElementById('descripcionEmergencia').value;
    const ubicacion = document.getElementById('ubicacionEmergencia').value;
    const personas = document.getElementById('personasAfectadas').value;
    const evacuacion = document.getElementById('requiereEvacuacion').checked;

    if (!tipo || !descripcion) {
        mostrarToast('Complete los campos obligatorios', 'warning');
        return;
    }

    const btn = document.getElementById('btnConfirmarEmergencia');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Activando...';

    try {
        let latitud = 5.7303596, longitud = -72.8943613;
        if (navigator.geolocation) {
            try {
                const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, {timeout: 5000}));
                latitud = pos.coords.latitude;
                longitud = pos.coords.longitude;
            } catch(e) {}
        }

        const r = await fetch('/api/emergencias/emergencias/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({
                tipo, descripcion, descripcion_ubicacion: ubicacion,
                latitud, longitud,
                personas_afectadas: parseInt(personas) || 0,
                requiere_evacuacion: evacuacion
            })
        });

        if (r.ok) {
            modalEmergencia.hide();
            document.getElementById('formEmergencia').reset();
            mostrarToast('EMERGENCIA ACTIVADA - Se ha notificado al personal', 'danger');
            cargarEmergencias();
        } else {
            const err = await r.json();
            mostrarToast('Error: ' + (err.detail || JSON.stringify(err)), 'danger');
        }
    } catch(e) {
        mostrarToast('Error de conexion: ' + e.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-megaphone-fill me-2"></i>CONFIRMAR EMERGENCIA';
    }
}

// === REFRESH UNIFICADO ===
function actualizarIndicadorTiempo() {
    const indicator = document.getElementById('lastUpdateIndicator');
    if (indicator) {
        indicator.innerHTML = `<i class="bi bi-arrow-repeat me-1"></i>${new Date().toLocaleTimeString('es-CO', {hour:'2-digit', minute:'2-digit', second:'2-digit'})}`;
    }
}

let refreshTimer = null;

function iniciarAutoRefresh() {
    refreshTimer = setInterval(() => {
        cargarEmergencias();
        cargarBrigadistas();
        cargarEstadoEquipos();
        actualizarIndicadorTiempo();
    }, 20000);
}

function refrescarTodo() {
    const btn = event.target.closest('button');
    const icon = btn.querySelector('i');
    icon.classList.add('spin-animation');
    Promise.all([
        cargarEmergencias(),
        cargarBrigadistas(),
        cargarEstadoEquipos(),
        cargarDisponibilidad()
    ]).then(() => {
        actualizarIndicadorTiempo();
        icon.classList.remove('spin-animation');
    }).catch(() => icon.classList.remove('spin-animation'));
}

// === INICIALIZACION ===
document.addEventListener('DOMContentLoaded', function() {
    modalEmergencia = new bootstrap.Modal(document.getElementById('modalEmergencia'));
    modalResolver = new bootstrap.Modal(document.getElementById('modalResolver'));
    modalFalsaAlarma = new bootstrap.Modal(document.getElementById('modalFalsaAlarma'));

    document.getElementById('btnConfirmarResolver').addEventListener('click', resolverEmergencia);
    document.getElementById('btnConfirmarFalsa').addEventListener('click', marcarFalsaAlarma);

    cargarDisponibilidad();
    cargarEmergencias();
    cargarBrigadistas();
    cargarEstadoEquipos();
    cargarTiposEmergencia();
    actualizarIndicadorTiempo();
    iniciarAutoRefresh();
});

// Pausar refresh cuando la pagina no es visible
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; }
    } else {
        cargarEmergencias();
        cargarBrigadistas();
        cargarDisponibilidad();
        actualizarIndicadorTiempo();
        iniciarAutoRefresh();
    }
});
</script>

<style>
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
.spin-animation {
    animation: spin 1s linear infinite;
}
@keyframes pulseMarker {
    0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
    50% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
}
</style>
{% endblock %}
