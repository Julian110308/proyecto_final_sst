{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard Brigada - Sistema SST{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Dashboard Brigada de Emergencia</li>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 fw-bold text-dark mb-1">
            <i class="bi bi-shield-fill-exclamation text-danger me-2"></i>
            Brigada de Emergencia - {{ user.get_full_name|default:user.username }}
        </h1>
        <p class="text-muted mb-0">
            Sistema de respuesta a emergencias y evacuación
            <span id="lastUpdateIndicator" class="ms-3 badge bg-light text-secondary">
                <i class="bi bi-arrow-repeat me-1"></i>Cargando...
            </span>
        </p>
    </div>
    <div class="btn-group">
        <button class="btn btn-outline-secondary" onclick="refrescarTodo()" title="Actualizar ahora">
            <i class="bi bi-arrow-clockwise"></i>
        </button>
        <button class="btn btn-danger btn-lg" onclick="mostrarModalEmergencia()" id="btnActivarEmergencia">
            <i class="bi bi-megaphone-fill me-2"></i>ACTIVAR EMERGENCIA
        </button>
        <button class="btn btn-outline-warning" onclick="window.location.href='/emergencias/'">
            <i class="bi bi-list-ul me-1"></i>Ver Todas
        </button>
    </div>
</div>

<!-- Modal de Activacion de Emergencia -->
<div class="modal fade" id="modalEmergencia" tabindex="-1" aria-labelledby="modalEmergenciaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalEmergenciaLabel">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>ACTIVAR EMERGENCIA
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Atencion:</strong> Esta accion activara una alerta de emergencia y notificara a todo el personal de brigada.
                </div>
                <form id="formEmergencia">
                    <div class="mb-3">
                        <label for="tipoEmergencia" class="form-label fw-bold">Tipo de Emergencia *</label>
                        <select class="form-select form-select-lg" id="tipoEmergencia" required>
                            <option value="">Seleccione el tipo...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="descripcionEmergencia" class="form-label fw-bold">Descripcion *</label>
                        <textarea class="form-control" id="descripcionEmergencia" rows="3" placeholder="Describa brevemente la situacion..." required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="ubicacionEmergencia" class="form-label fw-bold">Ubicacion</label>
                            <input type="text" class="form-control" id="ubicacionEmergencia" placeholder="Ej: Bloque A, segundo piso">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="personasAfectadas" class="form-label fw-bold">Personas afectadas (estimado)</label>
                            <input type="number" class="form-control" id="personasAfectadas" value="0" min="0">
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="requiereEvacuacion">
                            <label class="form-check-label fw-bold text-danger" for="requiereEvacuacion">
                                <i class="bi bi-sign-stop-fill me-1"></i>Requiere evacuacion inmediata
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger btn-lg" onclick="confirmarEmergencia()">
                    <i class="bi bi-megaphone-fill me-2"></i>CONFIRMAR EMERGENCIA
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Estado de Emergencias -->
<div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card card-modern border-0 border-start border-4" id="cardEstado">
            <div class="card-body p-4">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-2">Estado Actual</h6>
                        <h3 class="fw-bold mb-0" id="estadoTexto">Cargando...</h3>
                        <small id="estadoSub"><i class="bi bi-hourglass-split"></i> Verificando...</small>
                    </div>
                    <div class="bg-light rounded-3 p-3">
                        <i class="bi bi-shield-check fs-2" id="estadoIcono"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% include 'components/metric-card.html' with label="Personas en Centro" value=personas_en_centro|default:0 sublabel=porcentaje_ocupacion|default:0|add:"% ocupación" sublabel_icon="bi bi-building" sublabel_color="success" icon="bi-people-fill" icon_color="primary" border_color="primary" %}

    {% include 'components/metric-card.html' with label="Brigadistas Disponibles" value=brigadistas_disponibles|default:8|add:"/10" sublabel="En servicio activo" sublabel_icon="bi bi-person-check" sublabel_color="success" icon="bi-people-fill" icon_color="warning" border_color="warning" %}

    {% include 'components/metric-card.html' with label="Emergencias del Mes" value=emergencias_mes|default:8 sublabel="Atendidas" sublabel_icon="bi bi-exclamation-triangle" sublabel_color="info" icon="bi-shield-exclamation" icon_color="info" border_color="info" %}
</div>

<!-- Panel Principal -->
<div class="row g-4 mb-4">
    <!-- Emergencias Activas y Recientes -->
    <div class="col-lg-8">
        <div class="card card-modern">
            <div class="card-header-modern">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-exclamation-octagon-fill me-2"></i>
                        Estado de Emergencias
                    </h6>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary active">Activas</button>
                        <button class="btn btn-outline-secondary">Historial</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="alertaEmergencias"></div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Tipo</th>
                                <th>Ubicacion</th>
                                <th>Estado</th>
                                <th>Reportada</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaEmergencias">
                            <tr><td colspan="5" class="text-center py-4 text-muted">
                                <div class="spinner-border spinner-border-sm me-2"></div>Cargando...
                            </td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones Rápidas y Recursos -->
    <div class="col-lg-4">
        <!-- Acciones Rápidas -->
        <div class="card card-modern mb-4">
            <div class="card-header-modern">
                <h6 class="mb-0">
                    <i class="bi bi-lightning-charge-fill me-2"></i>
                    Acciones de Emergencia
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-3">
                    <button class="btn btn-danger text-start" onclick="activarEmergencia()">
                        <i class="bi bi-megaphone-fill me-2"></i>
                        Activar Emergencia
                    </button>
                    <button class="btn btn-outline-warning text-start" onclick="evacuarZona()">
                        <i class="bi bi-sign-stop-fill me-2"></i>
                        Evacuar Zona
                    </button>
                    <button class="btn btn-outline-info text-start" onclick="window.location.href='/mapas/'">
                        <i class="bi bi-map me-2"></i>
                        Mapa de Evacuación
                    </button>
                    <button class="btn btn-outline-primary text-start" onclick="verificarEquipos()">
                        <i class="bi bi-box-seam me-2"></i>
                        Verificar Equipos
                    </button>
                    <button class="btn btn-outline-secondary text-start" onclick="comunicarBrigada()">
                        <i class="bi bi-chat-dots me-2"></i>
                        Comunicar Brigada
                    </button>
                </div>
            </div>
        </div>

        <!-- Estado de Equipos (Dinamico) -->
        <div class="card card-modern">
            <div class="card-header-modern d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-tools me-2"></i>
                    Estado de Equipos <span class="badge bg-info ms-1" style="font-size:0.6rem;">EN VIVO</span>
                </h6>
                <a href="{% url 'equipos_brigada' %}" class="btn btn-sm btn-outline-primary">Ver todos</a>
            </div>
            <div class="card-body" id="estadoEquipos">
                <div class="text-center py-3 text-muted">
                    <div class="spinner-border spinner-border-sm me-2"></div>Cargando...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Incidentes Reportados -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card card-modern">
            <div class="card-header-modern d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-exclamation-triangle-fill me-2 text-warning"></i>
                    Incidentes Reportados
                    {% if incidentes_pendientes %}
                    <span class="badge bg-danger ms-2">{{ incidentes_pendientes }} pendiente{{ incidentes_pendientes|pluralize:"s" }}</span>
                    {% endif %}
                </h6>
                <a href="{% url 'listar_incidentes' %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-list-ul me-1"></i>Ver Todos
                </a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Incidente</th>
                                <th>Tipo</th>
                                <th>Gravedad</th>
                                <th>Estado</th>
                                <th>Reportado por</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for incidente in incidentes_recientes %}
                            <tr>
                                <td class="ps-4">
                                    <div class="fw-bold">{{ incidente.titulo }}</div>
                                    <small class="text-muted">{{ incidente.ubicacion }}</small>
                                </td>
                                <td><span class="badge bg-secondary">{{ incidente.get_tipo_display }}</span></td>
                                <td>
                                    {% if incidente.gravedad == 'CRITICA' %}
                                        <span class="badge bg-danger">Cr&iacute;tica</span>
                                    {% elif incidente.gravedad == 'ALTA' %}
                                        <span class="badge bg-warning text-dark">Alta</span>
                                    {% elif incidente.gravedad == 'MEDIA' %}
                                        <span class="badge bg-info">Media</span>
                                    {% else %}
                                        <span class="badge bg-success">Baja</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if incidente.estado == 'REPORTADO' %}
                                        <span class="badge bg-warning text-dark">Reportado</span>
                                    {% elif incidente.estado == 'EN_REVISION' or incidente.estado == 'EN_PROCESO' %}
                                        <span class="badge bg-info">En Proceso</span>
                                    {% elif incidente.estado == 'RESUELTO' %}
                                        <span class="badge bg-success">Resuelto</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ incidente.get_estado_display }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div>{{ incidente.reportado_por.get_full_name|default:incidente.reportado_por.username }}</div>
                                    <small class="text-muted">{{ incidente.reportado_por.get_rol_display }}</small>
                                </td>
                                <td>
                                    <small>{{ incidente.fecha_reporte|date:"d/m/Y" }}</small><br>
                                    <small class="text-muted">{{ incidente.fecha_reporte|time:"h:i A" }}</small>
                                </td>
                                <td>
                                    <a href="{% url 'detalle_incidente' incidente.id %}" class="btn btn-sm btn-outline-primary" title="Ver detalle">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center py-4 text-muted">
                                    <i class="bi bi-check-circle fs-4 d-block mb-2"></i>
                                    No hay incidentes reportados.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Brigadistas y Mapa -->
<div class="row g-4 mb-4">
    <!-- Equipo de Brigada -->
    <div class="col-lg-5">
        <div class="card card-modern">
            <div class="card-header-modern d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-people-fill me-2"></i>
                    Equipo de Brigada (10 Miembros)
                </h6>
                <button class="btn btn-sm btn-outline-primary" onclick="comunicarBrigada()">
                    <i class="bi bi-megaphone me-1"></i>Comunicar
                </button>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush" id="listaBrigadistas">
                    <div class="text-center py-3 text-muted"><div class="spinner-border spinner-border-sm me-2"></div>Cargando...</div>
                </div>
                <a href="{% url 'mi_brigada' %}" class="btn btn-sm btn-outline-secondary w-100 mt-3">
                    Ver todos los brigadistas
                </a>
            </div>
        </div>
    </div>

    <!-- Mapa de Evacuación -->
    <div class="col-lg-7">
        <div class="card card-modern">
            <div class="card-header-modern d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-geo-alt-fill me-2"></i>
                    Mapa de Evacuación y Puntos de Encuentro
                </h6>
                <button class="btn btn-sm btn-outline-primary" onclick="window.location.href='/mapas/'">
                    Ver Mapa Completo
                </button>
            </div>
            <div class="card-body p-0">
                <div id="evacuationMap" style="height: 450px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Timeline de Emergencias y Estadísticas -->
<div class="row g-4">
    <!-- Timeline de Emergencias -->
    <div class="col-lg-8">
        <div class="card card-modern">
            <div class="card-header-modern d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>
                    Timeline de Emergencias
                    <span class="badge bg-info ms-1" style="font-size:0.6rem;">EN VIVO</span>
                </h6>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary active" onclick="filtrarTimeline('todas')">Todas</button>
                    <button class="btn btn-outline-danger" onclick="filtrarTimeline('activas')">Activas</button>
                    <button class="btn btn-outline-success" onclick="filtrarTimeline('resueltas')">Resueltas</button>
                </div>
            </div>
            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                <div id="timelineEmergencias" class="timeline-container">
                    <div class="text-center py-4 text-muted">
                        <div class="spinner-border spinner-border-sm me-2"></div>Cargando timeline...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas del Mes -->
    <div class="col-lg-4">
        <div class="card card-modern mb-4">
            <div class="card-header-modern">
                <h6 class="mb-0">
                    <i class="bi bi-graph-up me-2"></i>
                    Estadísticas del Mes
                </h6>
            </div>
            <div class="card-body">
                <div id="statsEmergencias">
                    <div class="text-center py-3 text-muted">
                        <div class="spinner-border spinner-border-sm me-2"></div>Cargando...
                    </div>
                </div>
            </div>
        </div>

        <!-- Tiempos de Respuesta -->
        <div class="card card-modern">
            <div class="card-header-modern">
                <h6 class="mb-0">
                    <i class="bi bi-stopwatch me-2"></i>
                    Tiempos de Respuesta
                </h6>
            </div>
            <div class="card-body">
                <div id="tiemposRespuesta">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">Promedio de atencion</span>
                        <span class="fw-bold text-primary" id="tiempoPromedio">-- min</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">Mejor tiempo</span>
                        <span class="fw-bold text-success" id="tiempoMejor">-- min</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">Tiempo de resolucion</span>
                        <span class="fw-bold text-info" id="tiempoResolucion">-- min</span>
                    </div>
                    <hr>
                    <div class="text-center">
                        <small class="text-muted">Meta: &lt; 5 min atencion inicial</small>
                        <div class="progress mt-2" style="height: 8px;">
                            <div class="progress-bar bg-success" id="progressMeta" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Configuracion de auto-refresh
const REFRESH_INTERVAL = 30000; // 30 segundos
let refreshTimers = {};
let lastUpdate = null;
let modalEmergencia = null;

function getCookie(name) {
    let v = null;
    document.cookie.split(';').forEach(c => {
        c = c.trim();
        if (c.startsWith(name + '=')) v = decodeURIComponent(c.substring(name.length + 1));
    });
    return v;
}

function actualizarIndicadorTiempo() {
    const ahora = new Date();
    lastUpdate = ahora;
    const indicator = document.getElementById('lastUpdateIndicator');
    if (indicator) {
        indicator.innerHTML = `<i class="bi bi-arrow-repeat me-1"></i>Actualizado: ${ahora.toLocaleTimeString('es-CO', {hour:'2-digit', minute:'2-digit', second:'2-digit'})}`;
    }
}

function iniciarAutoRefresh() {
    // Refrescar emergencias y timeline cada 15 segundos (critico)
    refreshTimers.emergencias = setInterval(() => {
        cargarEmergencias();
        cargarTimeline();
        actualizarIndicadorTiempo();
    }, 15000);

    // Refrescar brigadistas cada 30 segundos
    refreshTimers.brigadistas = setInterval(() => {
        cargarBrigadistas();
    }, REFRESH_INTERVAL);

    // Refrescar equipos y estadisticas cada 60 segundos
    refreshTimers.equipos = setInterval(() => {
        cargarEstadoEquipos();
        cargarEstadisticas();
    }, 60000);

    console.log('Auto-refresh iniciado: emergencias/timeline cada 15s, brigadistas cada 30s, equipos/stats cada 60s');
}

function detenerAutoRefresh() {
    Object.values(refreshTimers).forEach(timer => clearInterval(timer));
    refreshTimers = {};
    console.log('Auto-refresh detenido');
}

// Mapa de Evacuación
const map = L.map('evacuationMap').setView([5.7303596, -72.8943613], 17);
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Esri'
}).addTo(map);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
    pane: 'overlayPane'
}).addTo(map);

// Iconos personalizados
const puntoEncuentroIcon = L.divIcon({
    className: 'custom-div-icon',
    html: '<div style="background-color:#4CAF50; width:35px; height:35px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">PE</div>',
    iconSize: [35, 35]
});

const extintorIcon = L.divIcon({
    className: 'custom-div-icon',
    html: '<div style="background-color:#f44336; width:25px; height:25px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold;">E</div>',
    iconSize: [25, 25]
});

// Cargar puntos de encuentro y equipamiento desde la API
fetch('/api/mapas/api/puntos-encuentro/')
    .then(r => r.json())
    .then(data => {
        (data.results || data).forEach(p => {
            L.marker([p.latitud, p.longitud], {icon: puntoEncuentroIcon}).addTo(map)
                .bindPopup(`<b>${p.nombre}</b><br>${p.descripcion || ''}<br>Capacidad: ${p.capacidad || '-'} personas`);
        });
    }).catch(() => {});

fetch('/api/mapas/api/equipamientos/')
    .then(r => r.json())
    .then(data => {
        (data.results || data).forEach(e => {
            if (e.tipo === 'EXTINTOR') {
                L.marker([e.latitud, e.longitud], {icon: extintorIcon}).addTo(map)
                    .bindPopup(`<b>${e.nombre}</b><br>${e.descripcion || ''}<br>Estado: ${e.estado}`);
            }
        });
    }).catch(() => {});

// Cargar datos dinamicos
document.addEventListener('DOMContentLoaded', function() {
    modalEmergencia = new bootstrap.Modal(document.getElementById('modalEmergencia'));
    cargarEmergencias();
    cargarBrigadistas();
    cargarEstadoEquipos();
    cargarTiposEmergencia();
    cargarTimeline();
    cargarEstadisticas();
    actualizarIndicadorTiempo();
    iniciarAutoRefresh();
});

// Detener refresh cuando la pagina no es visible
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        detenerAutoRefresh();
    } else {
        cargarEmergencias();
        cargarBrigadistas();
        cargarEstadoEquipos();
        cargarTimeline();
        cargarEstadisticas();
        actualizarIndicadorTiempo();
        iniciarAutoRefresh();
    }
});

async function cargarEmergencias() {
    try {
        const r = await fetch('/api/emergencias/emergencias/');
        const data = await r.json();
        const lista = data.results || data;

        const activas = lista.filter(e => e.estado === 'REPORTADA' || e.estado === 'EN_ATENCION');
        const recientes = lista.slice(0, 10);

        // Actualizar estado
        const card = document.getElementById('cardEstado');
        const texto = document.getElementById('estadoTexto');
        const sub = document.getElementById('estadoSub');
        const icono = document.getElementById('estadoIcono');

        if (activas.length > 0) {
            card.classList.add('border-danger');
            texto.className = 'fw-bold mb-0 text-danger';
            texto.textContent = 'EMERGENCIA';
            sub.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${activas.length} emergencia(s) activa(s)`;
            sub.className = 'text-danger';
            icono.className = 'bi bi-exclamation-triangle-fill fs-2 text-danger';
        } else {
            card.classList.add('border-success');
            texto.className = 'fw-bold mb-0 text-success';
            texto.textContent = 'NORMAL';
            sub.innerHTML = '<i class="bi bi-shield-check"></i> Sin emergencias activas';
            sub.className = 'text-success';
            icono.className = 'bi bi-check-circle-fill fs-2 text-success';
        }

        // Alerta
        const alertaDiv = document.getElementById('alertaEmergencias');
        if (activas.length > 0) {
            alertaDiv.innerHTML = `<div class="alert alert-danger mb-3"><i class="bi bi-exclamation-triangle-fill me-2"></i><strong>${activas.length} emergencia(s) activa(s)</strong> requieren atencion inmediata.</div>`;
        } else {
            alertaDiv.innerHTML = '<div class="alert alert-success mb-3"><i class="bi bi-check-circle-fill me-2"></i>Sin emergencias activas. Sistema operando normalmente.</div>';
        }

        // Tabla
        const tbody = document.getElementById('tablaEmergencias');
        if (!recientes.length) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">Sin emergencias registradas</td></tr>';
            return;
        }
        const estadoColor = {REPORTADA:'warning', EN_ATENCION:'info', CONTROLADA:'primary', RESUELTA:'success', FALSA_ALARMA:'secondary'};
        tbody.innerHTML = recientes.map(e => `
            <tr class="${(e.estado==='REPORTADA'||e.estado==='EN_ATENCION')?'table-warning':''}">
                <td><strong>${e.tipo_nombre || 'Emergencia'}</strong></td>
                <td>${e.descripcion_ubicacion || e.descripcion || '-'}</td>
                <td><span class="badge bg-${estadoColor[e.estado]||'secondary'}">${e.estado}</span></td>
                <td>${new Date(e.fecha_hora_reporte).toLocaleString('es-CO',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})}</td>
                <td>
                    <a href="/emergencias/" class="btn btn-sm btn-outline-secondary"><i class="bi bi-eye"></i></a>
                </td>
            </tr>`).join('');
    } catch(e) {
        document.getElementById('tablaEmergencias').innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error al cargar</td></tr>';
    }
}

async function cargarBrigadistas() {
    try {
        const r = await fetch('/api/emergencias/brigada/');
        const data = await r.json();
        const lista = data.results || data;
        const cont = document.getElementById('listaBrigadistas');

        if (!lista.length) {
            cont.innerHTML = '<p class="text-center text-muted py-3">No hay brigadistas registrados</p>';
            return;
        }
        const espNames = {PRIMEROS_AUXILIOS:'Primeros Auxilios', INCENDIOS:'Incendios', EVACUACION:'Evacuacion', RESCATE:'Rescate', COMUNICACIONES:'Comunicaciones', GENERAL:'General'};
        cont.innerHTML = lista.map(b => {
            const color = b.disponible ? 'success' : 'secondary';
            const icon = b.disponible ? 'bi-person-check-fill' : 'bi-person-x-fill';
            const estado = b.disponible ? 'Disponible' : 'No disponible';
            return `
                <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="avatar bg-${color} text-white rounded-circle me-3" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;">
                            <i class="bi ${icon}"></i>
                        </div>
                        <div>
                            <strong>${b.usuario_nombre || 'Brigadista'}</strong>
                            <p class="mb-0 small text-muted">${espNames[b.especializacion] || b.especializacion}</p>
                        </div>
                    </div>
                    <span class="badge bg-${color}">${estado}</span>
                </div>`;
        }).join('');
    } catch(e) {
        document.getElementById('listaBrigadistas').innerHTML = '<p class="text-center text-danger py-3">Error al cargar</p>';
    }
}

async function cargarEstadoEquipos() {
    try {
        const r = await fetch('/api/mapas/api/equipamientos/');
        const data = await r.json();
        const lista = data.results || data;
        const cont = document.getElementById('estadoEquipos');

        // Agrupar por tipo
        const porTipo = {};
        lista.forEach(e => {
            if (!porTipo[e.tipo]) {
                porTipo[e.tipo] = { total: 0, operativos: 0, items: [] };
            }
            porTipo[e.tipo].total++;
            if (e.estado === 'OPERATIVO') {
                porTipo[e.tipo].operativos++;
            }
            porTipo[e.tipo].items.push(e);
        });

        const iconos = {
            EXTINTOR: 'bi-fire text-danger',
            BOTIQUIN: 'bi-heart-pulse text-success',
            CAMILLA: 'bi-hospital text-primary',
            DESFIBRILADOR: 'bi-lightning-charge text-warning',
            HIDRANTE: 'bi-droplet-fill text-info',
            ALARMA: 'bi-bell text-warning',
            SENALIZACION: 'bi-signpost text-secondary'
        };

        const nombres = {
            EXTINTOR: 'Extintores',
            BOTIQUIN: 'Botiquines',
            CAMILLA: 'Camillas',
            DESFIBRILADOR: 'Desfibriladores',
            HIDRANTE: 'Hidrantes',
            ALARMA: 'Alarmas',
            SENALIZACION: 'Senalizacion'
        };

        if (Object.keys(porTipo).length === 0) {
            cont.innerHTML = '<p class="text-center text-muted py-2">Sin equipos registrados</p>';
            return;
        }

        let html = '';
        for (const [tipo, info] of Object.entries(porTipo)) {
            const pct = Math.round((info.operativos / info.total) * 100);
            let colorBar = 'success';
            let colorBadge = 'success';
            if (pct < 100) colorBar = 'warning';
            if (pct < 70) { colorBar = 'danger'; colorBadge = 'danger'; }

            const noOperativos = info.items.filter(e => e.estado !== 'OPERATIVO');
            let alertaHtml = '';
            if (noOperativos.length > 0) {
                alertaHtml = `<small class="text-muted">${noOperativos[0].nombre} requiere atencion</small>`;
            }

            html += `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span><i class="bi ${iconos[tipo] || 'bi-tools text-secondary'} me-2"></i>${nombres[tipo] || tipo}</span>
                        <span class="badge bg-${colorBadge}">${info.operativos}/${info.total}</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-${colorBar}" style="width: ${pct}%"></div>
                    </div>
                    ${alertaHtml}
                </div>`;
        }
        cont.innerHTML = html;
    } catch(e) {
        document.getElementById('estadoEquipos').innerHTML = '<p class="text-center text-danger py-2">Error al cargar</p>';
    }
}

async function cargarTiposEmergencia() {
    try {
        const r = await fetch('/api/emergencias/tipos/');
        const data = await r.json();
        const lista = data.results || data;
        const select = document.getElementById('tipoEmergencia');

        lista.forEach(tipo => {
            const option = document.createElement('option');
            option.value = tipo.id;
            option.textContent = `${tipo.nombre} (${tipo.prioridad_display || tipo.prioridad})`;
            select.appendChild(option);
        });
    } catch(e) {
        console.error('Error cargando tipos de emergencia:', e);
    }
}

function mostrarModalEmergencia() {
    modalEmergencia.show();
}

async function confirmarEmergencia() {
    const tipo = document.getElementById('tipoEmergencia').value;
    const descripcion = document.getElementById('descripcionEmergencia').value;
    const ubicacion = document.getElementById('ubicacionEmergencia').value;
    const personasAfectadas = document.getElementById('personasAfectadas').value;
    const requiereEvacuacion = document.getElementById('requiereEvacuacion').checked;

    if (!tipo || !descripcion) {
        alert('Por favor complete los campos obligatorios');
        return;
    }

    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Activando...';

    try {
        // Obtener ubicacion actual si es posible
        let latitud = 5.7303596; // Default SENA
        let longitud = -72.8943613;

        if (navigator.geolocation) {
            try {
                const pos = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {timeout: 5000});
                });
                latitud = pos.coords.latitude;
                longitud = pos.coords.longitude;
            } catch(e) {
                console.log('No se pudo obtener ubicacion, usando default');
            }
        }

        const r = await fetch('/api/emergencias/emergencias/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                tipo: tipo,
                descripcion: descripcion,
                descripcion_ubicacion: ubicacion,
                latitud: latitud,
                longitud: longitud,
                personas_afectadas: parseInt(personasAfectadas) || 0,
                requiere_evacuacion: requiereEvacuacion,
                estado: 'REPORTADA'
            })
        });

        if (r.ok) {
            modalEmergencia.hide();
            // Mostrar alerta de confirmacion
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index:9999;" role="alert">
                    <i class="bi bi-megaphone-fill me-2"></i>
                    <strong>EMERGENCIA ACTIVADA</strong> - Se ha notificado a todo el personal de brigada.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', alertHtml);

            // Limpiar formulario
            document.getElementById('formEmergencia').reset();

            // Recargar emergencias
            cargarEmergencias();
        } else {
            const error = await r.json();
            alert('Error al activar emergencia: ' + (error.detail || JSON.stringify(error)));
        }
    } catch(e) {
        alert('Error de conexion: ' + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-megaphone-fill me-2"></i>CONFIRMAR EMERGENCIA';
    }
}

function activarEmergencia() {
    mostrarModalEmergencia();
}

function evacuarZona() {
    if (confirm('EVACUAR ZONA?\n\nEsto activara el protocolo de evacuacion.')) {
        mostrarModalEmergencia();
        document.getElementById('requiereEvacuacion').checked = true;
    }
}

function verificarEquipos() {
    window.location.href = '{% url "equipos_brigada" %}';
}

function comunicarBrigada() {
    window.location.href = '{% url "mi_brigada" %}';
}

function refrescarTodo() {
    const btn = event.target.closest('button');
    const icon = btn.querySelector('i');
    icon.classList.add('spin-animation');

    Promise.all([
        cargarEmergencias(),
        cargarBrigadistas(),
        cargarEstadoEquipos(),
        cargarTimeline(),
        cargarEstadisticas()
    ]).then(() => {
        actualizarIndicadorTiempo();
        icon.classList.remove('spin-animation');
    }).catch(() => {
        icon.classList.remove('spin-animation');
    });
}

// Variables para el timeline
let todasLasEmergencias = [];
let filtroActual = 'todas';

async function cargarTimeline() {
    try {
        const r = await fetch('/api/emergencias/emergencias/');
        const data = await r.json();
        todasLasEmergencias = (data.results || data).sort((a, b) =>
            new Date(b.fecha_hora_reporte) - new Date(a.fecha_hora_reporte)
        );
        renderizarTimeline(filtroActual);
    } catch(e) {
        document.getElementById('timelineEmergencias').innerHTML =
            '<p class="text-center text-danger py-4">Error al cargar timeline</p>';
    }
}

function filtrarTimeline(filtro) {
    filtroActual = filtro;
    // Actualizar botones activos
    document.querySelectorAll('.card-header-modern .btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    renderizarTimeline(filtro);
}

function renderizarTimeline(filtro) {
    const cont = document.getElementById('timelineEmergencias');
    let lista = [...todasLasEmergencias];

    if (filtro === 'activas') {
        lista = lista.filter(e => e.estado === 'REPORTADA' || e.estado === 'EN_ATENCION');
    } else if (filtro === 'resueltas') {
        lista = lista.filter(e => e.estado === 'RESUELTA' || e.estado === 'CONTROLADA');
    }

    if (!lista.length) {
        cont.innerHTML = `
            <div class="text-center py-4 text-muted">
                <i class="bi bi-check-circle fs-2 d-block mb-2"></i>
                No hay emergencias ${filtro === 'activas' ? 'activas' : filtro === 'resueltas' ? 'resueltas' : ''} para mostrar
            </div>`;
        return;
    }

    const iconosEstado = {
        REPORTADA: 'bi-exclamation',
        EN_ATENCION: 'bi-person-gear',
        CONTROLADA: 'bi-shield-check',
        RESUELTA: 'bi-check-lg',
        FALSA_ALARMA: 'bi-x-lg'
    };

    const estadosTexto = {
        REPORTADA: 'Reportada',
        EN_ATENCION: 'En Atencion',
        CONTROLADA: 'Controlada',
        RESUELTA: 'Resuelta',
        FALSA_ALARMA: 'Falsa Alarma'
    };

    cont.innerHTML = lista.slice(0, 15).map(e => {
        const fecha = new Date(e.fecha_hora_reporte);
        const fechaStr = fecha.toLocaleDateString('es-CO', { day: '2-digit', month: 'short' });
        const horaStr = fecha.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });
        const esActiva = e.estado === 'REPORTADA' || e.estado === 'EN_ATENCION';

        // Calcular tiempo transcurrido
        const ahora = new Date();
        const diffMs = ahora - fecha;
        const diffMins = Math.floor(diffMs / 60000);
        let tiempoStr = '';
        if (diffMins < 60) {
            tiempoStr = `hace ${diffMins} min`;
        } else if (diffMins < 1440) {
            tiempoStr = `hace ${Math.floor(diffMins / 60)} h`;
        } else {
            tiempoStr = `hace ${Math.floor(diffMins / 1440)} dias`;
        }

        // Calcular tiempo de resolucion si esta resuelta
        let tiempoResolucion = '';
        if (e.fecha_hora_resolucion) {
            const fechaRes = new Date(e.fecha_hora_resolucion);
            const diffResMs = fechaRes - fecha;
            const diffResMins = Math.floor(diffResMs / 60000);
            if (diffResMins < 60) {
                tiempoResolucion = `Resuelto en ${diffResMins} min`;
            } else {
                tiempoResolucion = `Resuelto en ${Math.floor(diffResMins / 60)}h ${diffResMins % 60}min`;
            }
        }

        return `
            <div class="timeline-item" data-estado="${e.estado}">
                <div class="timeline-marker ${e.estado.toLowerCase()}">
                    <i class="bi ${iconosEstado[e.estado] || 'bi-circle'}"></i>
                </div>
                <div class="timeline-content ${esActiva ? 'activa' : ''}">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="timeline-time">${fechaStr} ${horaStr}</span>
                            <span class="text-muted mx-2">•</span>
                            <span class="timeline-time">${tiempoStr}</span>
                        </div>
                        <span class="badge bg-${esActiva ? 'danger' : e.estado === 'RESUELTA' ? 'success' : 'secondary'}">
                            ${estadosTexto[e.estado] || e.estado}
                        </span>
                    </div>
                    <div class="timeline-title">${e.tipo_nombre || 'Emergencia'}</div>
                    <div class="timeline-description">${e.descripcion || 'Sin descripcion'}</div>
                    <div class="timeline-meta">
                        ${e.descripcion_ubicacion ? `
                            <span class="timeline-meta-item">
                                <i class="bi bi-geo-alt"></i> ${e.descripcion_ubicacion}
                            </span>
                        ` : ''}
                        ${e.personas_afectadas ? `
                            <span class="timeline-meta-item">
                                <i class="bi bi-people"></i> ${e.personas_afectadas} afectados
                            </span>
                        ` : ''}
                        ${e.requiere_evacuacion ? `
                            <span class="timeline-meta-item text-danger">
                                <i class="bi bi-sign-stop-fill"></i> Evacuacion
                            </span>
                        ` : ''}
                        ${tiempoResolucion ? `
                            <span class="timeline-meta-item text-success">
                                <i class="bi bi-clock-history"></i> ${tiempoResolucion}
                            </span>
                        ` : ''}
                    </div>
                    ${esActiva ? `
                        <div class="timeline-actions">
                            <button class="btn btn-sm btn-info" onclick="atenderEmergencia(${e.id})">
                                <i class="bi bi-person-check me-1"></i>Atender
                            </button>
                            <button class="btn btn-sm btn-success" onclick="resolverEmergencia(${e.id})">
                                <i class="bi bi-check-circle me-1"></i>Resolver
                            </button>
                        </div>
                    ` : ''}
                </div>
            </div>`;
    }).join('');
}

async function cargarEstadisticas() {
    try {
        const r = await fetch('/api/emergencias/emergencias/');
        const data = await r.json();
        const lista = data.results || data;

        // Filtrar emergencias del mes actual
        const ahora = new Date();
        const inicioMes = new Date(ahora.getFullYear(), ahora.getMonth(), 1);
        const emergenciasMes = lista.filter(e => new Date(e.fecha_hora_reporte) >= inicioMes);

        // Contar por estado
        const stats = {
            reportadas: 0,
            en_atencion: 0,
            resueltas: 0,
            falsas_alarmas: 0
        };

        emergenciasMes.forEach(e => {
            if (e.estado === 'REPORTADA') stats.reportadas++;
            else if (e.estado === 'EN_ATENCION') stats.en_atencion++;
            else if (e.estado === 'RESUELTA' || e.estado === 'CONTROLADA') stats.resueltas++;
            else if (e.estado === 'FALSA_ALARMA') stats.falsas_alarmas++;
        });

        const cont = document.getElementById('statsEmergencias');
        cont.innerHTML = `
            <div class="row text-center mb-3">
                <div class="col-6 mb-3">
                    <div class="p-3 bg-danger bg-opacity-10 rounded">
                        <h4 class="text-danger mb-0">${stats.reportadas + stats.en_atencion}</h4>
                        <small class="text-muted">Activas</small>
                    </div>
                </div>
                <div class="col-6 mb-3">
                    <div class="p-3 bg-success bg-opacity-10 rounded">
                        <h4 class="text-success mb-0">${stats.resueltas}</h4>
                        <small class="text-muted">Resueltas</small>
                    </div>
                </div>
                <div class="col-6">
                    <div class="p-3 bg-warning bg-opacity-10 rounded">
                        <h4 class="text-warning mb-0">${emergenciasMes.length}</h4>
                        <small class="text-muted">Total Mes</small>
                    </div>
                </div>
                <div class="col-6">
                    <div class="p-3 bg-secondary bg-opacity-10 rounded">
                        <h4 class="text-secondary mb-0">${stats.falsas_alarmas}</h4>
                        <small class="text-muted">Falsas Alarmas</small>
                    </div>
                </div>
            </div>
            <hr>
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">Tasa de resolucion</small>
                <strong>${emergenciasMes.length > 0 ? Math.round((stats.resueltas / emergenciasMes.length) * 100) : 0}%</strong>
            </div>
            <div class="progress mt-2" style="height: 6px;">
                <div class="progress-bar bg-success" style="width: ${emergenciasMes.length > 0 ? Math.round((stats.resueltas / emergenciasMes.length) * 100) : 0}%"></div>
            </div>
        `;

        // Calcular tiempos de respuesta
        calcularTiemposRespuesta(lista);
    } catch(e) {
        document.getElementById('statsEmergencias').innerHTML =
            '<p class="text-center text-danger py-2">Error al cargar</p>';
    }
}

function calcularTiemposRespuesta(lista) {
    const resueltas = lista.filter(e => e.estado === 'RESUELTA' && e.fecha_hora_resolucion);

    if (resueltas.length === 0) {
        return;
    }

    let tiempoTotal = 0;
    let tiempoMinimo = Infinity;

    resueltas.forEach(e => {
        const inicio = new Date(e.fecha_hora_reporte);
        const fin = new Date(e.fecha_hora_resolucion);
        const diff = (fin - inicio) / 60000; // en minutos

        tiempoTotal += diff;
        if (diff < tiempoMinimo) tiempoMinimo = diff;
    });

    const promedio = Math.round(tiempoTotal / resueltas.length);

    document.getElementById('tiempoPromedio').textContent = `${promedio} min`;
    document.getElementById('tiempoMejor').textContent = tiempoMinimo < Infinity ? `${Math.round(tiempoMinimo)} min` : '-- min';
    document.getElementById('tiempoResolucion').textContent = `${promedio} min`;

    // Meta: menos de 5 minutos
    const cumpleMeta = resueltas.filter(e => {
        const inicio = new Date(e.fecha_hora_reporte);
        const fin = new Date(e.fecha_hora_resolucion);
        return (fin - inicio) / 60000 <= 5;
    }).length;

    const porcentajeMeta = Math.round((cumpleMeta / resueltas.length) * 100);
    document.getElementById('progressMeta').style.width = `${porcentajeMeta}%`;
}

async function atenderEmergencia(id) {
    if (!confirm('Confirmar que esta atendiendo esta emergencia?')) return;

    try {
        const r = await fetch(`/api/emergencias/emergencias/${id}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ estado: 'EN_ATENCION' })
        });

        if (r.ok) {
            cargarEmergencias();
            cargarTimeline();
        } else {
            alert('Error al actualizar emergencia');
        }
    } catch(e) {
        alert('Error de conexion');
    }
}

async function resolverEmergencia(id) {
    if (!confirm('Confirmar que esta emergencia ha sido resuelta?')) return;

    try {
        const r = await fetch(`/api/emergencias/emergencias/${id}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                estado: 'RESUELTA',
                fecha_hora_resolucion: new Date().toISOString()
            })
        });

        if (r.ok) {
            cargarEmergencias();
            cargarTimeline();
            cargarEstadisticas();
        } else {
            alert('Error al actualizar emergencia');
        }
    } catch(e) {
        alert('Error de conexion');
    }
}
</script>

<style>
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
.spin-animation {
    animation: spin 1s linear infinite;
}

/* Timeline Styles */
.timeline-container {
    position: relative;
    padding-left: 30px;
}

.timeline-container::before {
    content: '';
    position: absolute;
    left: 10px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(to bottom, #dee2e6 0%, #dee2e6 100%);
}

.timeline-item {
    position: relative;
    padding-bottom: 25px;
    padding-left: 20px;
}

.timeline-item:last-child {
    padding-bottom: 0;
}

.timeline-marker {
    position: absolute;
    left: -24px;
    top: 0;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.timeline-marker.reportada {
    background: #ffc107;
}

.timeline-marker.en_atencion {
    background: #17a2b8;
    animation: pulse 2s infinite;
}

.timeline-marker.controlada {
    background: #6f42c1;
}

.timeline-marker.resuelta {
    background: #28a745;
}

.timeline-marker.falsa_alarma {
    background: #6c757d;
}

@keyframes pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(23, 162, 184, 0.7); }
    50% { box-shadow: 0 0 0 10px rgba(23, 162, 184, 0); }
}

.timeline-content {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    border-left: 3px solid #dee2e6;
    transition: all 0.3s ease;
}

.timeline-content:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.timeline-content.activa {
    border-left-color: #dc3545;
    background: #fff5f5;
}

.timeline-time {
    font-size: 0.75rem;
    color: #6c757d;
}

.timeline-title {
    font-weight: 600;
    margin-bottom: 5px;
}

.timeline-description {
    font-size: 0.9rem;
    color: #495057;
    margin-bottom: 8px;
}

.timeline-meta {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    font-size: 0.8rem;
}

.timeline-meta-item {
    display: flex;
    align-items: center;
    gap: 5px;
    color: #6c757d;
}

.timeline-actions {
    margin-top: 10px;
    display: flex;
    gap: 8px;
}
</style>
{% endblock %}