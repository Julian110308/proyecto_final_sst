{% extends 'base.html' %}

{% block title %}Dashboard Aprendiz - Sistema SST{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Panel de Aprendiz</li>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 fw-bold text-dark mb-1">
            <i class="bi bi-mortarboard-fill text-primary me-2"></i>
            Bienvenido, {{ user.get_full_name|default:user.username }}
        </h1>
        <p class="text-muted mb-0">
            Aprendiz - {{ user.programa_formacion|default:"Programa de Formacion" }}
            {% if user.ficha %} | Ficha: {{ user.ficha }}{% endif %}
        </p>
    </div>
</div>

<!-- Tarjetas de Informacion Rapida -->
<div class="row g-3 mb-4">
    {% include 'components/metric-card.html' with label="Mis Ingresos Este Mes" value=mis_ingresos_mes|default:0 sublabel="Dias con acceso registrado" sublabel_icon="bi bi-calendar-check" sublabel_color="success" icon="bi-calendar-check" icon_color="success" border_color="success" %}

    <div class="col-xl-3 col-md-6">
        <div class="card card-modern border-0">
            <div class="card-body p-4">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-2">Estado Actual</h6>
                        <h3 class="fw-bold mb-0" id="estadoAprendiz">
                            <span class="text-muted"><i class="bi bi-hourglass-split"></i> Verificando...</span>
                        </h3>
                        <small class="text-muted" id="estadoSub"></small>
                    </div>
                    <div class="bg-light rounded-3 p-3">
                        <i class="bi bi-geo-alt fs-2 text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% include 'components/metric-card.html' with label="Mi Programa" value=user.programa_formacion|default:"Sin programa" sublabel="Programa de formacion" sublabel_icon="bi bi-mortarboard" sublabel_color="primary" icon="bi-mortarboard-fill" icon_color="primary" border_color="primary" %}

    {% include 'components/metric-card.html' with label="Dias Asistidos" value=dias_asistidos_mes|default:0 sublabel="Este mes" sublabel_icon="bi bi-calendar-check" sublabel_color="info" icon="bi-calendar-check-fill" icon_color="info" border_color="info" %}
</div>

<!-- Acciones Rapidas -->
<div class="card card-modern mb-4">
    <div class="card-header-modern">
        <h6 class="mb-0">
            <i class="bi bi-lightning-charge-fill me-2"></i>
            Acciones Rapidas
        </h6>
    </div>
    <div class="card-body">
        <div class="d-flex flex-wrap gap-3">
            <a href="{% url 'mi_asistencia' %}" class="btn btn-light border py-2 px-3 d-flex align-items-center text-decoration-none">
                <i class="bi bi-clock-history text-primary fs-5 me-2"></i>
                <span class="small">Mis Accesos</span>
            </a>
            <a href="/reportes/incidentes/nuevo/" class="btn btn-light border py-2 px-3 d-flex align-items-center text-decoration-none">
                <i class="bi bi-exclamation-triangle-fill text-danger fs-5 me-2"></i>
                <span class="small">Reportar Incidente</span>
            </a>
            <a href="/mapas/" class="btn btn-light border py-2 px-3 d-flex align-items-center text-decoration-none">
                <i class="bi bi-map text-success fs-5 me-2"></i>
                <span class="small">Mapa y Evacuacion</span>
            </a>
            <a href="{% url 'mis_alertas' %}" class="btn btn-light border py-2 px-3 d-flex align-items-center text-decoration-none">
                <i class="bi bi-bell-fill text-warning fs-5 me-2"></i>
                <span class="small">Mis Alertas</span>
            </a>
        </div>
    </div>
</div>

<!-- Grafica de Asistencia Mensual + Contactos de Emergencia -->
<div class="row g-4 mb-4">
    <div class="col-lg-8">
        <div class="card card-modern h-100">
            <div class="card-header-modern d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-graph-up me-2"></i>
                    Mi Asistencia - Ultimos 30 Dias
                </h6>
                <span class="badge bg-success-subtle text-success">{{ dias_asistidos_mes|default:0 }} dias asistidos</span>
            </div>
            <div class="card-body">
                <canvas id="chartAsistencia" height="100"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card card-modern border-start border-4 border-danger h-100">
            <div class="card-header-modern">
                <h6 class="mb-0">
                    <i class="bi bi-telephone-fill me-2 text-danger"></i>
                    Contactos de Emergencia
                </h6>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                    {% for contacto in contactos_emergencia %}
                    <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                        <div>
                            <span class="badge bg-secondary-subtle text-dark mb-1" style="font-size: 0.65rem;">{{ contacto.get_tipo_display }}</span>
                            <div class="fw-bold small">{{ contacto.nombre }}</div>
                            <small class="text-muted">{{ contacto.entidad }}</small>
                        </div>
                        <a href="tel:{{ contacto.telefono_principal }}" class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-telephone"></i> {{ contacto.telefono_principal }}
                        </a>
                    </li>
                    {% empty %}
                    <li class="list-group-item py-3">
                        <div class="fw-bold small"><i class="bi bi-hospital me-2"></i>Bomberos</div>
                        <small class="text-muted">Emergencias</small>
                        <span class="float-end badge bg-danger">119</span>
                    </li>
                    <li class="list-group-item py-3">
                        <div class="fw-bold small"><i class="bi bi-shield me-2"></i>Policia</div>
                        <small class="text-muted">Emergencias</small>
                        <span class="float-end badge bg-danger">123</span>
                    </li>
                    <li class="list-group-item py-3">
                        <div class="fw-bold small"><i class="bi bi-heart-pulse me-2"></i>Ambulancia</div>
                        <small class="text-muted">Cruz Roja</small>
                        <span class="float-end badge bg-danger">132</span>
                    </li>
                    {% endfor %}
                </ul>
                <div class="card-footer bg-danger-subtle text-center py-2">
                    <small class="text-danger fw-bold">
                        <i class="bi bi-exclamation-circle me-1"></i>
                        Linea Nacional de Emergencias: 123
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Historial de Acceso Reciente -->
<div class="card card-modern mb-4">
    <div class="card-header-modern d-flex justify-content-between align-items-center" style="cursor:pointer;" data-bs-toggle="collapse" data-bs-target="#collapseHistorial">
        <h6 class="mb-0">
            <i class="bi bi-clock-history me-2"></i>
            Mi Historial de Acceso Reciente
        </h6>
        <div class="d-flex align-items-center gap-2">
            <a href="{% url 'mi_asistencia' %}" class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation();">Ver todo</a>
            <i class="bi bi-chevron-down"></i>
        </div>
    </div>
    <div class="collapse show" id="collapseHistorial">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Fecha</th>
                            <th>Ingreso</th>
                            <th>Salida</th>
                            <th>Metodo</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for registro in mis_accesos %}
                        <tr>
                            <td class="ps-4 fw-bold">{{ registro.fecha_hora_ingreso|date:"d/m/Y" }}</td>
                            <td>{{ registro.fecha_hora_ingreso|time:"H:i" }}</td>
                            <td>
                                {% if registro.fecha_hora_egreso %}
                                    {{ registro.fecha_hora_egreso|time:"H:i" }}
                                {% else %}
                                    <span class="text-muted">--:--</span>
                                {% endif %}
                            </td>
                            <td><span class="badge bg-light text-dark border">{{ registro.get_metodo_ingreso_display }}</span></td>
                            <td>
                                {% if registro.fecha_hora_egreso %}
                                    <span class="badge bg-secondary-subtle text-secondary rounded-pill px-3">Completado</span>
                                {% else %}
                                    <span class="badge bg-success-subtle text-success rounded-pill px-3">En Centro</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">
                                <i class="bi bi-inbox fs-3 d-block mb-2"></i>
                                No hay registros de acceso este mes.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Informacion de Seguridad -->
<div class="card card-modern border-start border-4 border-info mb-4">
    <div class="card-header-modern d-flex justify-content-between align-items-center" style="cursor:pointer;" data-bs-toggle="collapse" data-bs-target="#collapseSeguridad">
        <h6 class="mb-0">
            <i class="bi bi-shield-check me-2"></i>
            Seguridad en el Centro
        </h6>
        <i class="bi bi-chevron-down"></i>
    </div>
    <div class="collapse" id="collapseSeguridad">
        <div class="card-body">
            <p class="text-muted small">
                Recuerda siempre portar tu carnet de identificacion y seguir los protocolos de seguridad del centro.
            </p>
            <ul class="list-unstyled small text-muted">
                <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Registra tu ingreso y salida</li>
                <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Conoce las rutas de evacuacion</li>
                <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Reporta cualquier incidente</li>
                <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Ubica los puntos de encuentro</li>
            </ul>
            <a href="/mapas/" class="btn btn-sm btn-outline-success">
                <i class="bi bi-map me-1"></i>Ver Rutas de Evacuacion
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    // Verificar estado actual del aprendiz
    try {
        const r = await fetch('/api/acceso/registros/registros_recientes/?limite=50');
        const data = await r.json();
        const miDoc = '{{ user.numero_documento }}';
        const miRegistro = data.find(d => d.usuario && d.usuario.documento === miDoc && !d.fecha_hora_egreso);
        const el = document.getElementById('estadoAprendiz');
        const sub = document.getElementById('estadoSub');
        if (miRegistro) {
            el.innerHTML = '<span class="text-success"><i class="bi bi-check-circle-fill"></i> En Centro</span>';
            sub.textContent = 'Ingreso: ' + new Date(miRegistro.fecha_hora_ingreso).toLocaleTimeString('es-CO', {hour:'2-digit', minute:'2-digit'});
        } else {
            el.innerHTML = '<span class="text-muted"><i class="bi bi-x-circle-fill"></i> Fuera</span>';
            sub.textContent = 'Sin ingreso activo hoy';
        }
    } catch(e) {
        document.getElementById('estadoAprendiz').innerHTML = '<span class="text-muted">--</span>';
    }

    // Grafica de Asistencia Mensual
    const ctx = document.getElementById('chartAsistencia');
    if (ctx) {
        const asistenciaData = [
            {% for dia in asistencia_mensual %}
            { fecha: '{{ dia.fecha }}', fechaCompleta: '{{ dia.fecha_completa }}', asistio: {{ dia.asistio }} }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: asistenciaData.map(d => d.fecha),
                datasets: [{
                    label: 'Asistencia',
                    data: asistenciaData.map(d => d.asistio),
                    backgroundColor: asistenciaData.map(d => d.asistio ? 'rgba(57, 169, 0, 0.8)' : 'rgba(200, 200, 200, 0.3)'),
                    borderColor: asistenciaData.map(d => d.asistio ? 'rgba(57, 169, 0, 1)' : 'rgba(200, 200, 200, 0.5)'),
                    borderWidth: 1,
                    borderRadius: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(items) {
                                const idx = items[0].dataIndex;
                                return asistenciaData[idx].fechaCompleta;
                            },
                            label: function(item) {
                                return item.raw === 1 ? 'Asistio' : 'No asistio';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        display: false,
                        max: 1.2
                    },
                    x: {
                        grid: { display: false },
                        ticks: {
                            font: { size: 9 },
                            maxRotation: 0,
                            callback: function(val, idx) {
                                return idx % 5 === 0 ? this.getLabelForValue(val) : '';
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
