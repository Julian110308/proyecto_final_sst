{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard Vigilancia - Sistema SST{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Dashboard Vigilancia</li>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 fw-bold text-dark mb-1">
            <i class="bi bi-shield-check text-primary me-2"></i>
            Control de Seguridad - {{ user.get_full_name|default:user.username }}
        </h1>
        <p class="text-muted mb-0">Control de acceso y vigilancia del centro</p>
    </div>
    <div class="btn-group">
        <button class="btn btn-primary" onclick="registrarAcceso()">
            <i class="bi bi-door-open me-1"></i>Registrar Acceso
        </button>
        <button class="btn btn-outline-info" onclick="registrarRonda()">
            <i class="bi bi-clipboard-check me-1"></i>Registrar Ronda
        </button>
        <button class="btn btn-outline-danger" onclick="alertaSeguridad()">
            <i class="bi bi-exclamation-triangle me-1"></i>Alerta
        </button>
    </div>
</div>

<!-- Estado del Sistema -->
<div class="row g-4 mb-4">
    {% include 'components/metric-card.html' with label="Personas en Centro" value=personas_en_centro|default:0 sublabel=porcentaje_ocupacion|default:0|add:"% ocupaci√≥n" sublabel_icon="bi bi-shield-check" sublabel_color="success" icon="bi-people-fill" icon_color="primary" border_color="primary" %}

    {% include 'components/metric-card.html' with label="Ingresos Hoy" value=ingresos_hoy|default:0 sublabel="Total del d√≠a" sublabel_color="info" icon="bi-box-arrow-in-right" icon_color="success" border_color="success" %}

    {% include 'components/metric-card.html' with label="Visitantes Hoy" value=visitantes_hoy|default:0 sublabel="Registrados" sublabel_icon="bi bi-person-badge" sublabel_color="warning" icon="bi-person-badge" icon_color="warning" border_color="warning" %}

    {% include 'components/metric-card.html' with label="Rondas del Turno" value="4" sublabel="√öltima: 11:30 AM" sublabel_icon="bi bi-check-circle" sublabel_color="success" icon="bi-clipboard-check" icon_color="info" border_color="info" %}
</div>

<!-- Registro de Accesos y Acciones R√°pidas -->
<div class="row g-4 mb-4">
    <div class="col-lg-8">
        <div class="card card-modern">
            <div class="card-header-modern">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        Registros de Acceso en Tiempo Real
                    </h6>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary active">Todos</button>
                        <button class="btn btn-outline-success">Ingresos</button>
                        <button class="btn btn-outline-danger">Egresos</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Hora</th>
                                <th>Usuario</th>
                                <th>Tipo</th>
                                <th>Acci√≥n</th>
                                <th>M√©todo</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="table-success">
                                <td><strong>11:45 AM</strong></td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar bg-primary text-white rounded-circle me-2" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 12px;">JP</div>
                                        <span>Juan P√©rez</span>
                                    </div>
                                </td>
                                <td><span class="badge bg-primary">Aprendiz</span></td>
                                <td><i class="bi bi-box-arrow-in-right text-success"></i> Ingreso</td>
                                <td>QR Code</td>
                                <td><span class="badge bg-success">Verificado</span></td>
                            </tr>
                            <tr class="table-danger">
                                <td><strong>11:42 AM</strong></td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar bg-success text-white rounded-circle me-2" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 12px;">MG</div>
                                        <span>Mar√≠a Gonz√°lez</span>
                                    </div>
                                </td>
                                <td><span class="badge bg-success">Instructor</span></td>
                                <td><i class="bi bi-box-arrow-right text-danger"></i> Egreso</td>
                                <td>Manual</td>
                                <td><span class="badge bg-success">Verificado</span></td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>11:38 AM</strong></td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar bg-warning text-white rounded-circle me-2" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 12px;">CL</div>
                                        <span>Carlos L√≥pez</span>
                                    </div>
                                </td>
                                <td><span class="badge bg-warning">Visitante</span></td>
                                <td><i class="bi bi-box-arrow-in-right text-success"></i> Ingreso</td>
                                <td>Manual</td>
                                <td><span class="badge bg-warning">Pendiente Autorizaci√≥n</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-3">
                    <button class="btn btn-sm btn-outline-secondary" onclick="window.location.href='/acceso/'">Ver historial completo</button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card card-modern mb-4">
            <div class="card-header-modern">
                <h6 class="mb-0">
                    <i class="bi bi-lightning-charge-fill me-2"></i>
                    Acciones R√°pidas
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-3">
                    <button class="btn btn-primary text-start" onclick="registrarAcceso()">
                        <i class="bi bi-door-open me-2"></i>Registrar Ingreso/Egreso
                    </button>
                    <button class="btn btn-outline-warning text-start" onclick="registrarVisitante()">
                        <i class="bi bi-person-plus me-2"></i>Registrar Visitante
                    </button>
                    <button class="btn btn-outline-info text-start" onclick="registrarRonda()">
                        <i class="bi bi-clipboard-check me-2"></i>Registrar Ronda
                    </button>
                    <button class="btn btn-outline-secondary text-start" onclick="objetosPerdidos()">
                        <i class="bi bi-box-seam me-2"></i>Objetos Perdidos
                    </button>
                    <button class="btn btn-outline-success text-start" onclick="buscarPersona()">
                        <i class="bi bi-search me-2"></i>Buscar Persona
                    </button>
                    <button class="btn btn-outline-danger text-start" onclick="alertaSeguridad()">
                        <i class="bi bi-exclamation-triangle me-2"></i>Reportar Alerta
                    </button>
                </div>
            </div>
        </div>

        <div class="card card-modern">
            <div class="card-header-modern">
                <h6 class="mb-0">
                    <i class="bi bi-camera-video me-2"></i>
                    C√°maras Activas
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-6">
                        <div class="border rounded p-2 text-center bg-light">
                            <i class="bi bi-camera-video-fill text-success fs-3"></i>
                            <p class="mb-0 small mt-1">Entrada Principal</p>
                            <span class="badge bg-success">Activa</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-2 text-center bg-light">
                            <i class="bi bi-camera-video-fill text-success fs-3"></i>
                            <p class="mb-0 small mt-1">Parqueadero</p>
                            <span class="badge bg-success">Activa</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-2 text-center bg-light">
                            <i class="bi bi-camera-video-fill text-success fs-3"></i>
                            <p class="mb-0 small mt-1">Talleres</p>
                            <span class="badge bg-success">Activa</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-2 text-center bg-light">
                            <i class="bi bi-camera-video-fill text-danger fs-3"></i>
                            <p class="mb-0 small mt-1">Salida Trasera</p>
                            <span class="badge bg-danger">Offline</span>
                        </div>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-primary w-100 mt-3" onclick="verTodasCamaras()">Ver Todas las C√°maras</button>
            </div>
        </div>
    </div>
</div>

<!-- Visitantes y Rondas -->
<div class="row g-4 mb-4">
    <div class="col-lg-7">
        <div class="card card-modern">
            <div class="card-header-modern d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-person-badge me-2"></i>
                    Visitantes Activos en Centro (15)
                </h6>
                <button class="btn btn-sm btn-primary" onclick="registrarVisitante()">
                    <i class="bi bi-plus-circle me-1"></i>Nuevo Visitante
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Visitante</th>
                                <th>Entidad</th>
                                <th>Visita a</th>
                                <th>Ingreso</th>
                                <th>Tiempo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Carlos M√©ndez</strong></td>
                                <td>Proveedor ABC</td>
                                <td>Ing. Rodr√≠guez</td>
                                <td>8:30 AM</td>
                                <td><span class="badge bg-warning">3h 15m</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger" onclick="registrarSalidaVisitante('Carlos')">
                                        <i class="bi bi-box-arrow-right"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Ana Vargas</strong></td>
                                <td>Auditor Externo</td>
                                <td>Director</td>
                                <td>9:00 AM</td>
                                <td><span class="badge bg-warning">2h 45m</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger" onclick="registrarSalidaVisitante('Ana')">
                                        <i class="bi bi-box-arrow-right"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Roberto L√≥pez</strong></td>
                                <td>Mantenimiento</td>
                                <td>Coordinador</td>
                                <td>10:15 AM</td>
                                <td><span class="badge bg-success">1h 30m</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger" onclick="registrarSalidaVisitante('Roberto')">
                                        <i class="bi bi-box-arrow-right"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-5">
        <div class="card card-modern mb-4">
            <div class="card-header-modern d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-clipboard-check me-2"></i>
                    Rondas del Turno
                </h6>
                <button class="btn btn-sm btn-primary" onclick="registrarRonda()">
                    <i class="bi bi-plus-circle me-1"></i>Nueva
                </button>
            </div>
            <div class="card-body">
                <div class="list-group">
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>11:30 AM - Ronda Completa</strong>
                                <p class="mb-1 small text-muted">‚úÖ Todas las √°reas revisadas</p>
                                <small class="text-success">Sin novedades</small>
                            </div>
                            <span class="badge bg-success">OK</span>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>9:45 AM - Ronda Completa</strong>
                                <p class="mb-1 small text-muted">‚ö†Ô∏è Puerta trasera abierta</p>
                                <small class="text-warning">Novedad reportada</small>
                            </div>
                            <span class="badge bg-warning">Novedad</span>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>7:30 AM - Ronda Inicio</strong>
                                <p class="mb-1 small text-muted">‚úÖ Inicio de turno normal</p>
                                <small class="text-success">Sin novedades</small>
                            </div>
                            <span class="badge bg-success">OK</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card card-modern">
            <div class="card-header-modern d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-box-seam me-2"></i>
                    Objetos Perdidos (3)
                </h6>
                <button class="btn btn-sm btn-outline-primary" onclick="objetosPerdidos()">Ver Todos</button>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item px-0">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-phone fs-3 text-primary me-3"></i>
                            <div>
                                <strong>Tel√©fono m√≥vil</strong>
                                <p class="mb-0 small text-muted">Encontrado en Cafeter√≠a - Hoy 10:00 AM</p>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item px-0">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-bag fs-3 text-success me-3"></i>
                            <div>
                                <strong>Mochila negra</strong>
                                <p class="mb-0 small text-muted">Encontrada en Talleres - Ayer 4:30 PM</p>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item px-0">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-key fs-3 text-warning me-3"></i>
                            <div>
                                <strong>Llavero</strong>
                                <p class="mb-0 small text-muted">Encontrado en Parqueadero - 15/12</p>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-secondary w-100 mt-2" onclick="objetosPerdidos()">Gestionar Objetos Perdidos</button>
            </div>
        </div>
    </div>
</div>

<!-- Mapa -->
<div class="row g-4">
    <div class="col-12">
        <div class="card card-modern">
            <div class="card-header-modern d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-geo-alt me-2"></i>
                    Mapa de Seguridad del Centro
                </h6>
                <button class="btn btn-sm btn-outline-primary" onclick="window.location.href='/mapas/'">Ver Mapa Completo</button>
            </div>
            <div class="card-body p-0">
                <div id="securityMap" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('securityMap').setView([5.5339, -73.3674], 17);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const entradaIcon = L.divIcon({
    className: 'custom-div-icon',
    html: '<div style="background-color:#4CAF50; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold;">E</div>',
    iconSize: [30, 30]
});

L.marker([5.5339, -73.3674], {icon: entradaIcon}).addTo(map).bindPopup('<b>Entrada Principal</b><br>Activa - Sin incidentes');
L.marker([5.5345, -73.3680], {icon: entradaIcon}).addTo(map).bindPopup('<b>Salida Trasera</b><br>Activa');

function registrarAcceso() {
    alert('Funci√≥n de registro de acceso. Se abrir√° formulario para registrar ingreso/egreso manual.');
}

function registrarVisitante() {
    alert('Funci√≥n para registrar nuevo visitante. Se abrir√° formulario con datos requeridos.');
}

function registrarRonda() {
    const puntos = prompt('Registrar Ronda de Seguridad:\n\nPuntos a revisar:\n1. Entrada Principal\n2. Parqueadero\n3. Talleres\n4. Salida Trasera\n5. √Årea Administrativa\n\n¬øTodos los puntos revisados? (SI/NO)');
    
    if (puntos && puntos.toUpperCase() === 'SI') {
        const novedades = prompt('¬øAlguna novedad para reportar? (Dejar vac√≠o si no hay novedades)');
        
        if (novedades === null) return;
        
        if (novedades.trim() === '') {
            alert('‚úÖ Ronda Registrada\n\nHora: ' + new Date().toLocaleTimeString() + '\nEstado: Sin novedades\nPuntos revisados: 5/5\n\n¬°Todas las √°reas seguras!');
        } else {
            alert('‚ö†Ô∏è Ronda Registrada con Novedad\n\nHora: ' + new Date().toLocaleTimeString() + '\nNovedad: ' + novedades + '\n\nLa novedad ha sido reportada al coordinador.');
        }
    }
}

function objetosPerdidos() {
    const opcion = prompt('Gesti√≥n de Objetos Perdidos:\n\n1. Registrar objeto encontrado\n2. Buscar objeto\n3. Entregar objeto\n4. Ver lista completa\n\nIngrese el n√∫mero de opci√≥n:');
    
    switch(opcion) {
        case '1':
            const objeto = prompt('Registrar Objeto Encontrado:\n\nDescripci√≥n del objeto:');
            if (objeto) {
                const ubicacion = prompt('¬øD√≥nde fue encontrado?');
                if (ubicacion) {
                    alert('‚úÖ Objeto Registrado\n\nObjeto: ' + objeto + '\nUbicaci√≥n: ' + ubicacion + '\nFecha: ' + new Date().toLocaleDateString() + '\nHora: ' + new Date().toLocaleTimeString() + '\n\nEl objeto qued√≥ registrado en custodia.');
                }
            }
            break;
        case '2':
            alert('Buscar Objeto:\n\nüì± Tel√©fono m√≥vil - Cafeter√≠a\nüéí Mochila negra - Talleres\nüîë Llavero - Parqueadero\nüìì Cuaderno - Biblioteca\nüí≥ Carnet - Entrada\n\nPuede filtrar por tipo, fecha o ubicaci√≥n.');
            break;
        case '3':
            const persona = prompt('Entregar Objeto:\n\nNombre de la persona que reclama:');
            if (persona) {
                const documento = prompt('N√∫mero de documento:');
                if (documento) {
                    alert('‚úÖ Objeto Entregado\n\nEntregado a: ' + persona + '\nDocumento: ' + documento + '\nFecha: ' + new Date().toLocaleDateString() + '\nHora: ' + new Date().toLocaleTimeString() + '\n\nFirma de recibido registrada.');
                }
            }
            break;
        case '4':
            alert('Lista Completa de Objetos Perdidos:\n\nüì± 3 Tel√©fonos\nüéí 2 Mochilas\nüîë 4 Llaveros\nüí≥ 5 Carnets\nüìì 2 Cuadernos\nüëì 1 Gafas\n‚åö 1 Reloj\n\nTotal: 18 objetos en custodia');
            break;
        default:
            if (opcion) alert('Opci√≥n no v√°lida');
    }
}

function buscarPersona() {
    const nombre = prompt('Ingrese el nombre o documento de la persona a buscar:');
    if (nombre) {
        alert(`Buscando informaci√≥n de: ${nombre}\n\nEsta funci√≥n mostrar√° el estado actual y historial de acceso.`);
    }
}

function alertaSeguridad() {
    if (confirm('¬øDesea reportar una ALERTA DE SEGURIDAD?\n\nEsto notificar√° inmediatamente al personal de emergencia.')) {
        alert('ALERTA ACTIVADA\n\nNotificaci√≥n enviada a:\n- Coordinador de Seguridad\n- Brigada de Emergencia\n- Personal Administrativo');
    }
}

function registrarSalidaVisitante(nombre) {
    if (confirm(`¬øRegistrar salida de ${nombre}?`)) {
        alert(`Salida de ${nombre} registrada exitosamente a las ${new Date().toLocaleTimeString()}`);
    }
}

function verTodasCamaras() {
    alert('Sistema de c√°maras de seguridad. Se mostrar√° vista en tiempo real de todas las c√°maras activas.');
}
</script>
{% endblock %}