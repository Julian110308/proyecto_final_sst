{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard Visitante - Sistema SST{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Bienvenido Visitante</li>
{% endblock %}

{% block content %}
<!-- Header de Bienvenida -->
<div class="text-center mb-4">
    <div class="mb-3">
        <div class="rounded-circle bg-success bg-opacity-10 d-inline-flex align-items-center justify-content-center" style="width:80px;height:80px;">
            <i class="bi bi-building" style="font-size: 40px; color: #2e7d32;"></i>
        </div>
    </div>
    <h1 class="h3 fw-bold text-dark mb-1">
        Bienvenido al Centro Minero SENA
    </h1>
    <p class="text-muted">{{ user.get_full_name|default:user.username }}</p>
    <div class="d-flex justify-content-center gap-2">
        <span class="badge bg-primary px-3 py-2">
            <i class="bi bi-person-badge me-1"></i>Visitante
        </span>
        <span class="badge bg-light text-dark border px-3 py-2" id="badgeEstado">
            <i class="bi bi-hourglass-split me-1"></i>Verificando...
        </span>
    </div>
</div>

<!-- Info de la Visita (dinamica) -->
<div class="row g-4 mb-4">
    <div class="col-md-8 mx-auto">
        <div class="card card-modern border-0 shadow-sm">
            <div class="card-header-modern text-center">
                <h6 class="mb-0">
                    <i class="bi bi-clipboard-check me-2"></i>
                    Informacion de su Visita
                </h6>
            </div>
            <div class="card-body p-4" id="infoVisita">
                <div class="text-center py-3 text-muted">
                    <div class="spinner-border spinner-border-sm me-2"></div>Cargando informacion...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Acciones Rapidas -->
<div class="row g-4 mb-4">
    <div class="col-md-8 mx-auto">
        <div class="card card-modern">
            <div class="card-header-modern">
                <h6 class="mb-0">
                    <i class="bi bi-grid-3x3-gap-fill me-2"></i>
                    Acciones disponibles
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <a href="/mapas/" class="btn btn-outline-primary w-100 py-3 text-decoration-none">
                            <i class="bi bi-map fs-4 d-block mb-1"></i>
                            <span class="fw-bold small">Ver Mapa</span>
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="{% url 'informacion_sst' %}" class="btn btn-outline-success w-100 py-3 text-decoration-none">
                            <i class="bi bi-shield-check fs-4 d-block mb-1"></i>
                            <span class="fw-bold small">Normas SST</span>
                        </a>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-danger w-100 py-3" onclick="reportarEmergencia()">
                            <i class="bi bi-exclamation-triangle fs-4 d-block mb-1"></i>
                            <span class="fw-bold small">Emergencia</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mapa del Centro -->
<div class="row g-4 mb-4">
    <div class="col-md-10 mx-auto">
        <div class="card card-modern">
            <div class="card-header-modern d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-geo-alt-fill me-2"></i>
                    Mapa del Centro
                </h6>
                <a href="/mapas/" class="btn btn-sm btn-outline-primary">Ver Completo</a>
            </div>
            <div class="card-body p-0">
                <div id="visitanteMap" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Normas de Seguridad (colapsable) -->
<div class="row g-4 mb-4">
    <div class="col-md-10 mx-auto">
        <div class="card card-modern">
            <div class="card-header-modern d-flex justify-content-between align-items-center" style="cursor:pointer;" data-bs-toggle="collapse" data-bs-target="#collapseNormas">
                <h6 class="mb-0">
                    <i class="bi bi-shield-exclamation text-warning me-2"></i>
                    Normas de Seguridad para Visitantes
                </h6>
                <i class="bi bi-chevron-down"></i>
            </div>
            <div class="collapse" id="collapseNormas">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li class="mb-3">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    <strong>Porte su identificacion</strong> de visitante en todo momento
                                </li>
                                <li class="mb-3">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    <strong>Permanezca en las areas</strong> autorizadas para su visita
                                </li>
                                <li class="mb-3">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    <strong>Respete las senales</strong> de seguridad y prohibicion
                                </li>
                                <li class="mb-3">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    <strong>Use elementos de proteccion</strong> si ingresa a talleres
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li class="mb-3">
                                    <i class="bi bi-x-circle-fill text-danger me-2"></i>
                                    <strong>No ingrese a areas restringidas</strong> sin autorizacion
                                </li>
                                <li class="mb-3">
                                    <i class="bi bi-x-circle-fill text-danger me-2"></i>
                                    <strong>No manipule equipos</strong> o maquinaria del centro
                                </li>
                                <li class="mb-3">
                                    <i class="bi bi-x-circle-fill text-danger me-2"></i>
                                    <strong>Prohibido fumar</strong> en todas las instalaciones
                                </li>
                                <li class="mb-3">
                                    <i class="bi bi-x-circle-fill text-danger me-2"></i>
                                    <strong>No bloquee salidas</strong> de emergencia
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- En caso de Emergencia (colapsable) -->
<div class="row g-4 mb-4">
    <div class="col-md-10 mx-auto">
        <div class="card card-modern border-danger">
            <div class="card-header-modern d-flex justify-content-between align-items-center" style="cursor:pointer;" data-bs-toggle="collapse" data-bs-target="#collapseEmergencia">
                <h6 class="mb-0 text-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    En Caso de Emergencia
                </h6>
                <i class="bi bi-chevron-down text-danger"></i>
            </div>
            <div class="collapse" id="collapseEmergencia">
                <div class="card-body">
                    <div class="row text-center g-3 mb-3">
                        <div class="col-md-3 col-6">
                            <div class="p-3 bg-light rounded">
                                <i class="bi bi-1-circle-fill text-danger fs-3 mb-1 d-block"></i>
                                <strong class="small">Mantenga la calma</strong>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="p-3 bg-light rounded">
                                <i class="bi bi-2-circle-fill text-danger fs-3 mb-1 d-block"></i>
                                <strong class="small">Siga senalizacion</strong>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="p-3 bg-light rounded">
                                <i class="bi bi-3-circle-fill text-danger fs-3 mb-1 d-block"></i>
                                <strong class="small">Punto de encuentro</strong>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="p-3 bg-light rounded">
                                <i class="bi bi-4-circle-fill text-danger fs-3 mb-1 d-block"></i>
                                <strong class="small">Espere instrucciones</strong>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-danger mb-0">
                        <strong>Emergencia Nacional: 123</strong> | Bomberos: 119 | Cruz Roja: 132
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Mapa del Centro - coordenadas reales del SENA Sogamoso
const map = L.map('visitanteMap').setView([5.7303596, -72.8943613], 17);
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Esri'
}).addTo(map);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
    pane: 'overlayPane'
}).addTo(map);

// Cargar puntos de encuentro desde la API
const peIcon = L.divIcon({
    className: 'custom-div-icon',
    html: '<div style="background:#4CAF50;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,.3);font-size:11px;">PE</div>',
    iconSize: [30, 30]
});

fetch('/api/mapas/api/puntos-encuentro/')
    .then(r => r.json())
    .then(data => {
        (data.results || data).forEach(p => {
            L.marker([p.latitud, p.longitud], {icon: peIcon}).addTo(map)
                .bindPopup(`<b>${p.nombre}</b><br>${p.descripcion || ''}<br>Capacidad: ${p.capacidad || '-'}`);
        });
    }).catch(() => {});

// Cargar info de visita del usuario
document.addEventListener('DOMContentLoaded', async function() {
    const cont = document.getElementById('infoVisita');
    const badge = document.getElementById('badgeEstado');

    try {
        const r = await fetch('/api/acceso/registros/registros_recientes/?limite=50');
        const data = await r.json();
        const miDoc = '{{ user.numero_documento }}';
        const miRegistro = data.find(d => d.usuario && d.usuario.documento === miDoc && !d.fecha_hora_egreso);

        if (miRegistro) {
            const ingreso = new Date(miRegistro.fecha_hora_ingreso);
            const ahora = new Date();
            const diffMin = Math.floor((ahora - ingreso) / 60000);
            const horas = Math.floor(diffMin / 60);
            const mins = diffMin % 60;

            badge.className = 'badge bg-success px-3 py-2';
            badge.innerHTML = '<i class="bi bi-check-circle me-1"></i>En el Centro';

            cont.innerHTML = `
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <div class="rounded-3 p-2 bg-success bg-opacity-10 me-3">
                                <i class="bi bi-clock-history fs-4 text-success"></i>
                            </div>
                            <div>
                                <small class="text-muted">Hora de Ingreso</small>
                                <h5 class="mb-0">${ingreso.toLocaleTimeString('es-CO', {hour:'2-digit', minute:'2-digit', hour12:true})}</h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <div class="rounded-3 p-2 bg-info bg-opacity-10 me-3">
                                <i class="bi bi-hourglass-split fs-4 text-info"></i>
                            </div>
                            <div>
                                <small class="text-muted">Tiempo en Centro</small>
                                <h5 class="mb-0">${horas > 0 ? horas + 'h ' : ''}${mins}min</h5>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info mt-3 mb-0 small">
                    <i class="bi bi-info-circle me-2"></i>
                    Mantenga visible su identificacion de visitante. Si necesita asistencia, dirijase a recepcion.
                </div>`;
        } else {
            badge.className = 'badge bg-secondary px-3 py-2';
            badge.innerHTML = '<i class="bi bi-x-circle me-1"></i>Sin ingreso activo';

            cont.innerHTML = `
                <div class="text-center py-3">
                    <i class="bi bi-info-circle fs-3 text-muted d-block mb-2"></i>
                    <p class="text-muted mb-0">No tiene un ingreso activo registrado hoy.</p>
                    <small class="text-muted">Dirijase a recepcion para registrar su ingreso.</small>
                </div>`;
        }
    } catch(e) {
        cont.innerHTML = `
            <div class="text-center py-3">
                <i class="bi bi-building fs-3 text-muted d-block mb-2"></i>
                <p class="text-muted mb-1">Bienvenido al Centro Minero SENA</p>
                <small class="text-muted">Si necesita asistencia, dirijase a recepcion o contacte al personal de vigilancia.</small>
            </div>`;
        badge.className = 'badge bg-primary px-3 py-2';
        badge.innerHTML = '<i class="bi bi-person-badge me-1"></i>Visitante';
    }
});

function reportarEmergencia() {
    if (confirm('Desea reportar una emergencia? Se notificara al personal de seguridad.')) {
        window.location.href = '/dashboard/';
    }
}
</script>
{% endblock %}
