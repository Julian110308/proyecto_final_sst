{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard Administrativo - Sistema SST{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Dashboard Administrativo</li>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 fw-bold text-dark mb-1">
            <i class="bi bi-speedometer2 text-primary me-2"></i>
            Panel Administrativo - {{ user.get_full_name|default:user.username }}
        </h1>
        <p class="text-muted mb-0">Control total del sistema SST - Centro Minero SENA</p>
    </div>
    <div class="btn-group">
        <button class="btn btn-primary" onclick="window.location.href='/reportes/'">
            <i class="bi bi-file-earmark-bar-graph me-1"></i>Reportes Avanzados
        </button>
        <button class="btn btn-success" onclick="exportarDatos()">
            <i class="bi bi-download me-1"></i>Exportar Datos
        </button>
        <button class="btn btn-outline-secondary" onclick="configurarSistema()">
            <i class="bi bi-gear me-1"></i>Configuración
        </button>
    </div>
</div>

<!-- Filtros de Periodo -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card card-modern">
            <div class="card-body py-3">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-secondary active">Hoy</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary">Esta Semana</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary">Este Mes</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary">Año</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary">Personalizado</button>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <small class="text-muted">
                            <i class="bi bi-clock me-1"></i>
                            Última actualización: Hace 2 minutos
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Métricas Principales -->
<div class="row g-4 mb-4">
    <!-- Total Usuarios -->
    <div class="col-xl-3 col-md-6">
        <div class="card card-modern border-0 border-start border-4 border-primary">
            <div class="card-body p-4">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-2">Total Usuarios Registrados</h6>
                        <h3 class="fw-bold text-dark mb-0">245</h3>
                        <small class="text-success">
                            <i class="bi bi-arrow-up-short"></i> +12 este mes
                        </small>
                    </div>
                    <div class="bg-light rounded-3 p-3" style="background: #e3f2fd !important;">
                        <i class="bi bi-people-fill fs-2 text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Personas en Centro -->
    <div class="col-xl-3 col-md-6">
        <div class="card card-modern border-0 border-start border-4 border-success">
            <div class="card-body p-4">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-2">Personas en Centro Ahora</h6>
                        <h3 class="fw-bold text-dark mb-0">156</h3>
                        <small class="text-info">63.7% de capacidad</small>
                    </div>
                    <div class="bg-light-green rounded-3 p-3">
                        <i class="bi bi-building fs-2 text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ingresos Totales Hoy -->
    <div class="col-xl-3 col-md-6">
        <div class="card card-modern border-0 border-start border-4 border-info">
            <div class="card-body p-4">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-2">Ingresos Totales Hoy</h6>
                        <h3 class="fw-bold text-dark mb-0">189</h3>
                        <small class="text-success">
                            <i class="bi bi-arrow-up-short"></i> +8% vs ayer
                        </small>
                    </div>
                    <div class="bg-light rounded-3 p-3" style="background: #e3f2fd !important;">
                        <i class="bi bi-door-open-fill fs-2 text-info"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Emergencias del Mes -->
    <div class="col-xl-3 col-md-6">
        <div class="card card-modern border-0 border-start border-4 border-warning">
            <div class="card-body p-4">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-2">Incidentes Este Mes</h6>
                        <h3 class="fw-bold text-dark mb-0">8</h3>
                        <small class="text-success">
                            <i class="bi bi-arrow-down-short"></i> -25% vs mes anterior
                        </small>
                    </div>
                    <div class="bg-light-warning rounded-3 p-3">
                        <i class="bi bi-exclamation-triangle-fill fs-2 text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gráficos Principales -->
<div class="row g-4 mb-4">
    <!-- Gráfico de Actividad -->
    <div class="col-lg-8">
        <div class="card card-modern">
            <div class="card-header-modern">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-graph-up me-2"></i>
                        Actividad en Tiempo Real - Últimas 24 Horas
                    </h6>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            Ingresos/Egresos
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#">Ingresos/Egresos</a></li>
                            <li><a class="dropdown-item" href="#">Solo Ingresos</a></li>
                            <li><a class="dropdown-item" href="#">Solo Egresos</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <canvas id="actividadChart" height="80"></canvas>
            </div>
        </div>
    </div>

    <!-- Estadísticas por Rol -->
    <div class="col-lg-4">
        <div class="card card-modern">
            <div class="card-header-modern">
                <h6 class="mb-0">
                    <i class="bi bi-pie-chart me-2"></i>
                    Distribución por Rol
                </h6>
            </div>
            <div class="card-body">
                <canvas id="rolesChart"></canvas>
                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span><i class="bi bi-circle-fill text-primary me-2"></i>Aprendices</span>
                        <strong>180</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span><i class="bi bi-circle-fill text-success me-2"></i>Instructores</span>
                        <strong>35</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span><i class="bi bi-circle-fill text-warning me-2"></i>Vigilancia</span>
                        <strong>12</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span><i class="bi bi-circle-fill text-info me-2"></i>Administrativos</span>
                        <strong>8</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-circle-fill text-danger me-2"></i>Brigada</span>
                        <strong>10</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gestión de Usuarios y Visitantes -->
<div class="row g-4 mb-4">
    <!-- Últimos Usuarios Registrados -->
    <div class="col-lg-6">
        <div class="card card-modern">
            <div class="card-header-modern d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-person-plus me-2"></i>
                    Últimos Usuarios Registrados
                </h6>
                <button class="btn btn-sm btn-primary" onclick="gestionarUsuarios()">
                    <i class="bi bi-gear me-1"></i>Gestionar
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Usuario</th>
                                <th>Rol</th>
                                <th>Fecha Registro</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar bg-primary text-white rounded-circle me-2" style="width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;">
                                            JD
                                        </div>
                                        <span>Juan Díaz</span>
                                    </div>
                                </td>
                                <td><span class="badge bg-primary">Aprendiz</span></td>
                                <td>Hoy</td>
                                <td><span class="badge bg-success">Activo</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="editarUsuario('Juan Díaz')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar bg-success text-white rounded-circle me-2" style="width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;">
                                            LM
                                        </div>
                                        <span>Laura Moreno</span>
                                    </div>
                                </td>
                                <td><span class="badge bg-success">Instructor</span></td>
                                <td>Ayer</td>
                                <td><span class="badge bg-success">Activo</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="editarUsuario('Laura Moreno')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar bg-warning text-white rounded-circle me-2" style="width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;">
                                            PS
                                        </div>
                                        <span>Pedro Sánchez</span>
                                    </div>
                                </td>
                                <td><span class="badge bg-warning">Vigilancia</span></td>
                                <td>16/12</td>
                                <td><span class="badge bg-success">Activo</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="editarUsuario('Pedro Sánchez')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Visitantes Activos -->
    <div class="col-lg-6">
        <div class="card card-modern">
            <div class="card-header-modern d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-person-badge me-2"></i>
                    Visitantes en Centro (15 activos)
                </h6>
                <button class="btn btn-sm btn-outline-primary" onclick="window.location.href='/acceso/'">
                    Ver Todos
                </button>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Carlos Méndez</strong>
                            <p class="mb-0 small text-muted">Proveedor ABC | Ingresó: 8:30 AM</p>
                        </div>
                        <span class="badge bg-warning">3h 15m</span>
                    </div>
                    <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Ana Vargas</strong>
                            <p class="mb-0 small text-muted">Auditor Externo | Ingresó: 9:00 AM</p>
                        </div>
                        <span class="badge bg-warning">2h 45m</span>
                    </div>
                    <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Roberto López</strong>
                            <p class="mb-0 small text-muted">Mantenimiento | Ingresó: 10:15 AM</p>
                        </div>
                        <span class="badge bg-success">1h 30m</span>
                    </div>
                    <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                        <div>
                            <strong>María González</strong>
                            <p class="mb-0 small text-muted">Entidad Gov. | Ingresó: 11:00 AM</p>
                        </div>
                        <span class="badge bg-success">45m</span>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <button class="btn btn-sm btn-outline-secondary" onclick="window.location.href='/acceso/'">
                        Ver los 15 visitantes activos
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mapa y Emergencias -->
<div class="row g-4 mb-4">
    <!-- Mapa del Centro -->
    <div class="col-lg-7">
        <div class="card card-modern">
            <div class="card-header-modern d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-map me-2"></i>
                    Mapa Interactivo del Centro
                </h6>
                <button class="btn btn-sm btn-outline-primary" onclick="window.location.href='/mapas/'">
                    Ver Mapa Completo
                </button>
            </div>
            <div class="card-body p-0">
                <div id="miniMap" style="height: 350px;"></div>
            </div>
        </div>
    </div>

    <!-- Gestión de Emergencias -->
    <div class="col-lg-5">
        <div class="card card-modern">
            <div class="card-header-modern d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-exclamation-octagon me-2"></i>
                    Estado de Emergencias
                </h6>
                <button class="btn btn-sm btn-outline-danger" onclick="window.location.href='/emergencias/'">
                    Ver Todas
                </button>
            </div>
            <div class="card-body">
                <div class="alert alert-success mb-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-check-circle-fill fs-4 me-3"></i>
                        <div>
                            <strong>Sistema Estable</strong>
                            <p class="mb-0 small">No hay emergencias activas en este momento</p>
                        </div>
                    </div>
                </div>

                <h6 class="mb-3">Últimas Emergencias Resueltas:</h6>
                <div class="list-group">
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="badge bg-warning mb-2">Menor</span>
                                <p class="mb-1 fw-bold">Corte de energía - Bloque B</p>
                                <small class="text-muted">Resuelta hace 2 días</small>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="verDetalleEmergencia(1)">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="badge bg-info mb-2">Información</span>
                                <p class="mb-1 fw-bold">Simulacro de evacuación</p>
                                <small class="text-muted">Completado hace 1 semana</small>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="verDetalleEmergencia(2)">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <h6>Estadísticas del Mes:</h6>
                    <div class="row text-center">
                        <div class="col-4">
                            <h5 class="text-danger mb-0">2</h5>
                            <small class="text-muted">Críticas</small>
                        </div>
                        <div class="col-4">
                            <h5 class="text-warning mb-0">4</h5>
                            <small class="text-muted">Menores</small>
                        </div>
                        <div class="col-4">
                            <h5 class="text-info mb-0">2</h5>
                            <small class="text-muted">Información</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Acciones Administrativas -->
<div class="row g-4">
    <div class="col-12">
        <div class="card card-modern">
            <div class="card-header-modern">
                <h6 class="mb-0">
                    <i class="bi bi-tools me-2"></i>
                    Herramientas Administrativas
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <button class="btn btn-outline-primary w-100 py-3" onclick="gestionarUsuarios()">
                            <i class="bi bi-people fs-4 d-block mb-2"></i>
                            <span class="fw-bold">Gestionar Usuarios</span>
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-success w-100 py-3" onclick="window.location.href='/reportes/'">
                            <i class="bi bi-file-earmark-bar-graph fs-4 d-block mb-2"></i>
                            <span class="fw-bold">Reportes Avanzados</span>
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-info w-100 py-3" onclick="exportarDatos()">
                            <i class="bi bi-download fs-4 d-block mb-2"></i>
                            <span class="fw-bold">Exportar Datos</span>
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-warning w-100 py-3" onclick="configurarSistema()">
                            <i class="bi bi-gear fs-4 d-block mb-2"></i>
                            <span class="fw-bold">Configuración</span>
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary w-100 py-3" onclick="auditoria()">
                            <i class="bi bi-shield-check fs-4 d-block mb-2"></i>
                            <span class="fw-bold">Auditoría</span>
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-danger w-100 py-3" onclick="respaldoSistema()">
                            <i class="bi bi-database fs-4 d-block mb-2"></i>
                            <span class="fw-bold">Respaldo BD</span>
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-primary w-100 py-3" onclick="estadisticasAvanzadas()">
                            <i class="bi bi-graph-up-arrow fs-4 d-block mb-2"></i>
                            <span class="fw-bold">Estadísticas</span>
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-success w-100 py-3" onclick="notificaciones()">
                            <i class="bi bi-bell fs-4 d-block mb-2"></i>
                            <span class="fw-bold">Notificaciones</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Gráfico de Actividad
const ctxActividad = document.getElementById('actividadChart');
if (ctxActividad) {
    new Chart(ctxActividad, {
        type: 'line',
        data: {
            labels: ['00:00', '03:00', '06:00', '09:00', '12:00', '15:00', '18:00', '21:00'],
            datasets: [{
                label: 'Ingresos',
                data: [5, 8, 45, 120, 95, 85, 60, 25],
                borderColor: '#4caf50',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                tension: 0.4
            }, {
                label: 'Egresos',
                data: [2, 5, 20, 60, 80, 110, 90, 40],
                borderColor: '#ff9800',
                backgroundColor: 'rgba(255, 152, 0, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { position: 'top' } }
        }
    });
}

// Gráfico de Roles
const ctxRoles = document.getElementById('rolesChart');
if (ctxRoles) {
    new Chart(ctxRoles, {
        type: 'doughnut',
        data: {
            labels: ['Aprendices', 'Instructores', 'Vigilancia', 'Administrativos', 'Brigada'],
            datasets: [{
                data: [180, 35, 12, 8, 10],
                backgroundColor: ['#2196f3', '#4caf50', '#ff9800', '#00bcd4', '#f44336']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } }
        }
    });
}

// Mapa
const map = L.map('miniMap').setView([5.5339, -73.3674], 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.marker([5.5339, -73.3674]).addTo(map).bindPopup('Centro Minero SENA');

// Funciones
function gestionarUsuarios() {
    alert('Módulo de gestión de usuarios. Crear, editar, desactivar usuarios.');
}

function exportarDatos() {
    if (confirm('¿Exportar todos los datos del sistema a Excel?')) {
        alert('Exportando datos... Descarga iniciará en breve.');
    }
}

function configurarSistema() {
    alert('Configuración del sistema. Parámetros, permisos, notificaciones.');
}

function editarUsuario(nombre) {
    alert(`Editar datos de ${nombre}`);
}

function verDetalleEmergencia(id) {
    alert(`Ver detalles de emergencia #${id}`);
}

function auditoria() {
    alert('Sistema de auditoría. Logs, historial de cambios, reportes de seguridad.');
}

function respaldoSistema() {
    if (confirm('¿Crear respaldo completo de la base de datos?')) {
        alert('Creando respaldo... Esto puede tomar unos minutos.');
    }
}

function estadisticasAvanzadas() {
    alert('Estadísticas avanzadas con filtros personalizados y análisis predictivo.');
}

function notificaciones() {
    alert('Centro de notificaciones. Enviar alertas masivas al personal.');
}
</script>
{% endblock %}