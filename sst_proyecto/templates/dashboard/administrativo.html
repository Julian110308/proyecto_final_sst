{% extends 'base.html' %}

{% block title %}Dashboard Administrativo - Sistema SST{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Panel Administrativo</li>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 fw-bold text-dark mb-1">
            <i class="bi bi-briefcase-fill text-primary me-2"></i>
            Panel Administrativo
        </h1>
        <p class="text-muted mb-0">
            {{ user.get_full_name|default:user.username }} - Gestion integral del Centro Minero SENA
        </p>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'gestion_usuarios' %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-people me-1"></i>Usuarios
        </a>
        <a href="{% url 'configuracion_sistema' %}" class="btn btn-primary btn-sm text-white">
            <i class="bi bi-gear me-1"></i>Configuracion
        </a>
    </div>
</div>

<!-- Metricas Principales -->
<div class="row g-3 mb-4">
    {% include 'components/metric-card.html' with label="Personas en Centro" value=personas_en_centro|default:0 sublabel=porcentaje_ocupacion|default:0|add:"% ocupacion" sublabel_icon="bi bi-building" sublabel_color="success" icon="bi-people-fill" icon_color="primary" border_color="primary" %}

    {% include 'components/metric-card.html' with label="Ingresos Hoy" value=ingresos_hoy|default:0 sublabel="Registros de entrada" sublabel_color="muted" icon="bi-box-arrow-in-right" icon_color="success" border_color="success" %}

    {% include 'components/metric-card.html' with label="Visitantes" value=visitantes_hoy|default:0 sublabel="Externos activos" sublabel_color="warning" icon="bi-person-badge" icon_color="warning" border_color="warning" %}

    {% include 'components/metric-card.html' with label="Total Usuarios" value=total_usuarios|default:0 sublabel=usuarios_mes|default:0|add:" nuevos este mes" sublabel_icon="bi bi-arrow-up-short" sublabel_color="success" icon="bi-person-check" icon_color="info" border_color="info" %}
</div>

<!-- Accesos Rapidos -->
<div class="card card-modern mb-4">
    <div class="card-header-modern">
        <h6 class="mb-0">
            <i class="bi bi-lightning-charge-fill me-2"></i>Gestion Rapida
        </h6>
    </div>
    <div class="card-body">
        <div class="d-flex flex-wrap gap-3">
            <a href="{% url 'gestion_usuarios' %}" class="btn btn-light border py-2 px-3 d-flex align-items-center text-decoration-none">
                <i class="bi bi-person-plus text-success fs-5 me-2"></i>
                <span class="small">Gestionar Usuarios</span>
            </a>
            <a href="{% url 'reportes_general' %}" class="btn btn-light border py-2 px-3 d-flex align-items-center text-decoration-none">
                <i class="bi bi-file-earmark-text text-primary fs-5 me-2"></i>
                <span class="small">Ver Reportes</span>
            </a>
            <a href="{% url 'listar_incidentes' %}" class="btn btn-light border py-2 px-3 d-flex align-items-center text-decoration-none">
                <i class="bi bi-shield-exclamation text-warning fs-5 me-2"></i>
                <span class="small">Ver Incidentes</span>
            </a>
            <a href="/emergencias/" class="btn btn-light border py-2 px-3 d-flex align-items-center text-decoration-none">
                <i class="bi bi-exclamation-triangle text-danger fs-5 me-2"></i>
                <span class="small">Emergencias</span>
            </a>
            <a href="/acceso/" class="btn btn-light border py-2 px-3 d-flex align-items-center text-decoration-none">
                <i class="bi bi-door-open text-info fs-5 me-2"></i>
                <span class="small">Control de Acceso</span>
            </a>
            <a href="/mapas/" class="btn btn-light border py-2 px-3 d-flex align-items-center text-decoration-none">
                <i class="bi bi-map text-secondary fs-5 me-2"></i>
                <span class="small">Mapa del Centro</span>
            </a>
>>>>>>> julian
        </div>
    </div>
</div>

<!-- Grafico + Accesos Recientes -->
<div class="row g-4 mb-4">
    <div class="col-lg-8">
        <div class="card card-modern h-100">
            <div class="card-header-modern">
                <h6 class="mb-0">
                    <i class="bi bi-bar-chart-line me-2"></i>
                    Actividad de Ingresos - Ultimos 7 Dias
                </h6>
            </div>
            <div class="card-body">
                <canvas id="ingresosChart" height="100"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card card-modern h-100">
            <div class="card-header-modern d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>
                    Accesos Recientes
                </h6>
                <a href="/acceso/" class="btn btn-sm btn-outline-secondary">Ver todo</a>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for acceso in ultimos_accesos %}
                    <div class="list-group-item border-0 px-3 py-2">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle bg-success bg-opacity-10 text-success d-flex align-items-center justify-content-center me-2" style="width:35px;height:35px;min-width:35px;">
                                <span class="fw-bold small">{{ acceso.usuario.username|slice:":1"|upper }}</span>
                            </div>
                            <div class="flex-grow-1 overflow-hidden">
                                <div class="fw-bold small text-truncate">{{ acceso.usuario.get_full_name }}</div>
                                <small class="text-muted">{{ acceso.usuario.get_rol_display }}</small>
                            </div>
                            <div class="text-end">
                                <small class="fw-bold">{{ acceso.fecha_hora_ingreso|date:"H:i" }}</small>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-inbox fs-3 d-block mb-2"></i>
                        No hay registros recientes
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('ingresosChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [{% for item in ultimos_7_dias %}'{{ item.fecha }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    label: 'Ingresos',
                    data: [{% for item in ultimos_7_dias %}{{ item.cantidad }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: '#39A900',
                    hoverBackgroundColor: '#2E8B00',
                    borderRadius: 6,
                    barThickness: 25
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { borderDash: [4, 4], color: '#F3F4F6' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }
});
</script>
{% endblock %}
