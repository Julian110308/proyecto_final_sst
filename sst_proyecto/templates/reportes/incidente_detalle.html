{% extends 'base.html' %}

{% block title %}{{ incidente.titulo }} - Sistema SST{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'listar_incidentes' %}">Incidentes</a></li>
<li class="breadcrumb-item active">{{ incidente.titulo }}</li>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 fw-bold text-dark mb-1">
            <i class="bi bi-file-text-fill text-warning me-2"></i>
            {{ incidente.titulo }}
        </h1>
        <p class="text-muted mb-0">Detalles del incidente reportado</p>
    </div>
    <div>
        {% if user.rol == 'ADMINISTRATIVO' %}
        <a href="{% url 'actualizar_incidente' incidente.pk %}" class="btn btn-primary">
            <i class="bi bi-pencil-square me-1"></i>
            Actualizar Estado
        </a>
        {% endif %}
        <a href="{% url 'listar_incidentes' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left me-1"></i>
            Volver
        </a>
    </div>
</div>

<div class="row g-4 mb-4">
    <!-- Columna Principal -->
    <div class="col-lg-8">
        <!-- Descripcion -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Descripcion del Incidente</h5>
            </div>
            <div class="card-body">
                <p class="mb-0">{{ incidente.descripcion }}</p>
            </div>
        </div>

        <!-- Version del Accidente -->
        {% if incidente.version_accidente %}
        <div class="card mb-3">
            <div class="card-header bg-info bg-opacity-10">
                <h5 class="mb-0"><i class="bi bi-chat-quote me-2"></i>Version del Accidente</h5>
            </div>
            <div class="card-body">
                <p class="mb-0" style="white-space: pre-line;">{{ incidente.version_accidente }}</p>
            </div>
        </div>
        {% endif %}

        <!-- Ubicacion y Lugar -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Ubicacion del Incidente</h5>
            </div>
            <div class="card-body">
                {% if incidente.area_incidente %}
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Area del Incidente</small>
                    <span class="badge bg-primary fs-6">{{ incidente.get_area_incidente_display }}</span>
                </div>
                {% endif %}

                {% if incidente.ubicacion %}
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Ubicacion General</small>
                    <p class="mb-0">{{ incidente.ubicacion }}</p>
                </div>
                {% endif %}

                {% if incidente.lugar_exacto %}
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Lugar Exacto</small>
                    <p class="mb-0">{{ incidente.lugar_exacto }}</p>
                </div>
                {% endif %}

                {% if incidente.latitud and incidente.longitud %}
                <div class="mb-0">
                    <small class="text-muted d-block mb-1">Ubicacion en el Mapa</small>
                    <div id="mapaDetalle" style="height: 250px; border-radius: 8px;"></div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Riesgos Identificados -->
        {% if incidente.riesgos_identificados %}
        <div class="card mb-3">
            <div class="card-header bg-warning bg-opacity-10">
                <h5 class="mb-0"><i class="bi bi-exclamation-diamond me-2 text-warning"></i>Riesgos Identificados</h5>
            </div>
            <div class="card-body">
                <p class="mb-0" style="white-space: pre-line;">{{ incidente.riesgos_identificados }}</p>
            </div>
        </div>
        {% endif %}

        <!-- Persona Afectada -->
        {% if incidente.persona_afectada %}
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-person-exclamation me-2"></i>Persona Afectada</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <small class="text-muted d-block mb-1">Nombre</small>
                        <strong>{{ incidente.persona_afectada }}</strong>
                    </div>
                    {% if incidente.documento_afectado %}
                    <div class="col-md-4">
                        <small class="text-muted d-block mb-1">Documento</small>
                        <strong>{{ incidente.documento_afectado }}</strong>
                    </div>
                    {% endif %}
                    {% if incidente.rol_afectado %}
                    <div class="col-md-4">
                        <small class="text-muted d-block mb-1">Rol</small>
                        <span class="badge bg-secondary">{{ incidente.rol_afectado }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Testigos -->
        {% if incidente.testigos %}
        <div class="card mb-3">
            <div class="card-header" style="background: rgba(111, 66, 193, 0.1);">
                <h5 class="mb-0"><i class="bi bi-people me-2" style="color: #6f42c1;"></i>Testigos del Incidente</h5>
            </div>
            <div class="card-body">
                <p class="mb-0" style="white-space: pre-line;">{{ incidente.testigos }}</p>
            </div>
        </div>
        {% endif %}

        <!-- Foto de Evidencia -->
        {% if incidente.foto %}
        <div class="card mb-3">
            <div class="card-header bg-danger bg-opacity-10">
                <h5 class="mb-0"><i class="bi bi-camera me-2 text-danger"></i>Evidencia Fotografica</h5>
            </div>
            <div class="card-body text-center">
                <img src="{{ incidente.foto.url }}" alt="Evidencia" class="img-fluid rounded" style="max-height: 400px;">
            </div>
        </div>
        {% endif %}

        <!-- Acciones Tomadas -->
        {% if incidente.acciones_tomadas %}
        <div class="card mb-3">
            <div class="card-header bg-success bg-opacity-10">
                <h5 class="mb-0"><i class="bi bi-clipboard-check me-2 text-success"></i>Acciones Tomadas</h5>
            </div>
            <div class="card-body">
                <p class="mb-0">{{ incidente.acciones_tomadas }}</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Panel Lateral -->
    <div class="col-lg-4">
        <!-- Estado -->
        <div class="card mb-3">
            <div class="card-body">
                <h6 class="text-muted mb-3">Estado del Incidente</h6>

                {% if incidente.estado == 'REPORTADO' %}
                <span class="badge bg-warning fs-6 mb-3">{{ incidente.get_estado_display }}</span>
                {% elif incidente.estado == 'EN_REVISION' or incidente.estado == 'EN_PROCESO' %}
                <span class="badge bg-info fs-6 mb-3">{{ incidente.get_estado_display }}</span>
                {% else %}
                <span class="badge bg-success fs-6 mb-3">{{ incidente.get_estado_display }}</span>
                {% endif %}

                <hr>

                <!-- Tipo -->
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Tipo</small>
                    <span class="badge bg-secondary">{{ incidente.get_tipo_display }}</span>
                </div>

                <!-- Gravedad -->
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Gravedad</small>
                    {% if incidente.gravedad == 'CRITICA' %}
                    <span class="badge bg-danger">Critica</span>
                    {% elif incidente.gravedad == 'ALTA' %}
                    <span class="badge bg-warning">Alta</span>
                    {% elif incidente.gravedad == 'MEDIA' %}
                    <span class="badge bg-info">Media</span>
                    {% else %}
                    <span class="badge bg-secondary">Baja</span>
                    {% endif %}
                </div>

                <!-- Area -->
                {% if incidente.area_incidente %}
                <div class="mb-0">
                    <small class="text-muted d-block mb-1">Area</small>
                    <span class="badge bg-primary">{{ incidente.get_area_incidente_display }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Fechas -->
        <div class="card mb-3">
            <div class="card-body">
                <h6 class="text-muted mb-3">Fechas Importantes</h6>

                <div class="mb-3">
                    <small class="text-muted d-block mb-1">
                        <i class="bi bi-calendar-event me-1"></i>
                        Fecha del Incidente
                    </small>
                    <strong>{{ incidente.fecha_incidente|date:"d/m/Y H:i" }}</strong>
                </div>

                <div class="mb-3">
                    <small class="text-muted d-block mb-1">
                        <i class="bi bi-clock me-1"></i>
                        Fecha de Reporte
                    </small>
                    <strong>{{ incidente.fecha_reporte|date:"d/m/Y H:i" }}</strong>
                </div>

                {% if incidente.fecha_resolucion %}
                <div class="mb-0">
                    <small class="text-muted d-block mb-1">
                        <i class="bi bi-check-circle me-1"></i>
                        Fecha de Resolucion
                    </small>
                    <strong>{{ incidente.fecha_resolucion|date:"d/m/Y H:i" }}</strong>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Responsables -->
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted mb-3">Responsables</h6>

                <div class="mb-3">
                    <small class="text-muted d-block mb-1">
                        <i class="bi bi-person me-1"></i>
                        Reportado por
                    </small>
                    <strong>{{ incidente.reportado_por.get_full_name|default:incidente.reportado_por.username }}</strong>
                    <br>
                    <small class="text-muted">{{ incidente.reportado_por.get_rol_display }}</small>
                </div>

                {% if incidente.asignado_a %}
                <div class="mb-0">
                    <small class="text-muted d-block mb-1">
                        <i class="bi bi-person-check me-1"></i>
                        Asignado a
                    </small>
                    <strong>{{ incidente.asignado_a.get_full_name|default:incidente.asignado_a.username }}</strong>
                    <br>
                    <small class="text-muted">{{ incidente.asignado_a.get_rol_display }}</small>
                </div>
                {% else %}
                <div class="mb-0">
                    <small class="text-muted d-block mb-1">
                        <i class="bi bi-person-check me-1"></i>
                        Asignado a
                    </small>
                    <span class="text-muted fst-italic">Sin asignar</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% if incidente.latitud and incidente.longitud %}
{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const lat = {{ incidente.latitud }};
    const lng = {{ incidente.longitud }};

    const mapa = L.map('mapaDetalle').setView([lat, lng], 18);

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Esri', maxZoom: 19
    }).addTo(mapa);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
        maxZoom: 19, opacity: 0.7
    }).addTo(mapa);

    L.marker([lat, lng], {
        icon: L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        })
    }).addTo(mapa).bindPopup('<strong>Lugar del incidente</strong><br>{{ incidente.ubicacion|default:"" }}').openPopup();
});
</script>
{% endblock %}
{% endif %}
