{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-5">
    <div>
        <h1 class="h3 fw-bold text-dark mb-1">Gesti√≥n de Emergencias</h1>
        <p class="text-muted">Sistema de respuesta y alertas tempranas</p>
    </div>
    <div class="btn-group">
        <button class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#modalEmergencia">
            <i class="bi bi-exclamation-triangle me-1"></i>
            Reportar Emergencia
        </button>
    </div>
</div>

<!-- Alertas de Emergencia Activas -->
<div class="mb-4">
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <i class="bi bi-info-circle-fill me-2"></i>
        <strong>Sistema de emergencias activo</strong> - Todas las funciones operativas
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
</div>

<div class="row">
    <!-- Panel de Control Emergencias -->
    <div class="col-lg-4">
        <div class="card card-modern mb-4">
            <div class="card-header bg-warning text-white py-3">
                <h6 class="m-0 fw-bold">
                    <i class="bi bi-megaphone me-2"></i>
                    Acciones R√°pidas
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="notificarBrigada()">
                        <i class="bi bi-bell me-1"></i>
                        Notificar Brigada
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="contactarEmergencias()">
                        <i class="bi bi-telephone me-1"></i>
                        Contactar Emergencias
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="iniciarEvacuacion()">
                        <i class="bi bi-arrow-right-square me-1"></i>
                        Iniciar Evacuaci√≥n
                    </button>
                </div>
            </div>
        </div>

        <!-- Brigada Disponible -->
        <div class="card card-modern mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 fw-bold text-primary">Brigada de Emergencia</h6>
            </div>
            <div class="card-body" id="listaBrigadistas">
                <!-- Los brigadistas se cargar√°n aqu√≠ con JavaScript -->
                <div class="text-center text-muted py-3">
                    <i class="bi bi-hourglass-split"></i>
                    Cargando brigadistas...
                </div>
            </div>
        </div>

        <!-- Contactos de Emergencia -->
        <div class="card card-modern">
            <div class="card-header py-3">
                <h6 class="m-0 fw-bold text-primary">Contactos de Emergencia</h6>
            </div>
            <div class="card-body" id="listaContactos">
                <!-- Los contactos se cargar√°n aqu√≠ con JavaScript -->
                <div class="text-center text-muted py-3">
                    <i class="bi bi-hourglass-split"></i>
                    Cargando contactos...
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Emergencias -->
    <div class="col-lg-8">
        <!-- Emergencias Activas -->
        <div class="card card-modern mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 fw-bold text-primary">Emergencias Activas</h6>
                <span class="badge bg-warning">0 activas</span>
            </div>
            <div class="card-body">
                <div class="text-center text-muted py-4">
                    <i class="bi bi-check-circle fs-1 mb-2 d-block text-success"></i>
                    No hay emergencias activas en este momento
                </div>
            </div>
        </div>

        <!-- Historial de Emergencias -->
        <div class="card card-modern">
            <div class="card-header py-3">
                <h6 class="m-0 fw-bold text-primary">Historial de Emergencias</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Tipo</th>
                                <th>Ubicaci√≥n</th>
                                <th>Reportado por</th>
                                <th>Estado</th>
                                <th>Hora</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox fs-1 mb-2 d-block"></i>
                                    No hay emergencias registradas
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Reportar Emergencia -->
<div class="modal fade" id="modalEmergencia" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Reportar Emergencia
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formEmergencia">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Tipo de Emergencia *</label>
                        <select class="form-select" id="tipoEmergencia" required>
                            <option value="">Seleccionar tipo...</option>
                            <!-- Se cargar√° din√°micamente -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripci√≥n *</label>
                        <textarea class="form-control" id="descripcionEmergencia" rows="3"
                                  placeholder="Describe la emergencia..." required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ubicaci√≥n *</label>
                        <input type="text" class="form-control" id="ubicacionEmergencia"
                               placeholder="Edificio, √°rea o coordenadas" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Personas Afectadas (aproximadamente)</label>
                        <input type="number" class="form-control" id="personasAfectadas" value="0" min="0">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="reportarEmergencia()">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    Reportar Emergencia
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Cargar tipos de emergencia cuando se abre el modal
document.addEventListener('DOMContentLoaded', function() {
    cargarTiposEmergencia();
    cargarEmergenciasActivas();
    cargarBrigadistas();  // Cargar brigadistas disponibles
    cargarContactos();    // Cargar contactos de emergencia
});

// Funci√≥n simple para cargar tipos de emergencia
function cargarTiposEmergencia() {
    fetch('/api/emergencias/tipos/')
        .then(response => response.json())
        .then(tipos => {
            const select = document.getElementById('tipoEmergencia');
            select.innerHTML = '<option value="">Seleccionar tipo...</option>';

            tipos.forEach(tipo => {
                select.innerHTML += `<option value="${tipo.id}">${tipo.nombre}</option>`;
            });
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

// Funci√≥n simple para cargar emergencias activas
function cargarEmergenciasActivas() {
    fetch('/api/emergencias/emergencias/?estado=REPORTADA,EN_ATENCION')
        .then(response => response.json())
        .then(emergencias => {
            // Aqu√≠ puedes actualizar la tabla si hay emergencias
            console.log('Emergencias activas:', emergencias);
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

// Funci√≥n SIMPLE para cargar brigadistas disponibles
function cargarBrigadistas() {
    console.log('Cargando brigadistas...');

    // Llamar a la API de brigadistas disponibles
    fetch('/api/emergencias/brigada/disponibles/')
        .then(response => {
            console.log('Respuesta brigadistas:', response.status);
            return response.json();
        })
        .then(brigadistas => {
            console.log('Brigadistas recibidos:', brigadistas.length);

            // Obtener el contenedor
            const contenedor = document.getElementById('listaBrigadistas');

            // Si no hay brigadistas
            if (brigadistas.length === 0) {
                contenedor.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-info-circle"></i>
                        No hay brigadistas disponibles
                    </div>
                `;
                return;
            }

            // Limpiar el contenedor
            contenedor.innerHTML = '';

            // Agregar cada brigadista con un bucle FOR simple
            for (let i = 0; i < brigadistas.length; i++) {
                const brigadista = brigadistas[i];

                // Crear el nombre completo
                let nombre = brigadista.first_name + ' ' + brigadista.last_name;
                if (nombre.trim() === '') {
                    nombre = brigadista.username;
                }

                // Crear el HTML del brigadista
                const html = `
                    <div class="d-flex align-items-center mb-3 p-2 bg-light rounded">
                        <div class="bg-primary rounded-circle p-2 me-3">
                            <i class="bi bi-person-fill text-white"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-0">${nombre}</h6>
                            <small class="text-muted">Brigada de Emergencia</small>
                        </div>
                        <span class="badge bg-success">Disponible</span>
                    </div>
                `;

                // Agregar al contenedor
                contenedor.innerHTML += html;
            }
        })
        .catch(error => {
            console.error('ERROR al cargar brigadistas:', error);
            document.getElementById('listaBrigadistas').innerHTML = `
                <div class="alert alert-danger">
                    Error al cargar brigadistas
                </div>
            `;
        });
}

// Funci√≥n SIMPLE para cargar contactos de emergencia
function cargarContactos() {
    console.log('Cargando contactos...');

    // Llamar a la API de contactos
    fetch('/api/emergencias/contactos/')
        .then(response => {
            console.log('Respuesta contactos:', response.status);
            return response.json();
        })
        .then(contactos => {
            console.log('Contactos recibidos:', contactos.length);

            // Obtener el contenedor
            const contenedor = document.getElementById('listaContactos');

            // Si no hay contactos
            if (contactos.length === 0) {
                contenedor.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-info-circle"></i>
                        No hay contactos registrados
                    </div>
                `;
                return;
            }

            // Limpiar el contenedor
            contenedor.innerHTML = '';

            // Agregar cada contacto con un bucle FOR simple
            for (let i = 0; i < contactos.length; i++) {
                const contacto = contactos[i];

                // Decidir si es el √∫ltimo (sin borde inferior)
                const claseExtra = (i < contactos.length - 1) ? 'border-bottom' : '';

                // Crear el HTML del contacto
                const html = `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 ${claseExtra}">
                        <div>
                            <h6 class="mb-0">${contacto.nombre}</h6>
                            <small class="text-muted">${contacto.descripcion || 'Contacto de emergencia'}</small>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">${contacto.telefono}</div>
                            <button class="btn btn-sm btn-outline-success" onclick="llamarContacto('${contacto.telefono}')">
                                <i class="bi bi-telephone"></i>
                            </button>
                        </div>
                    </div>
                `;

                // Agregar al contenedor
                contenedor.innerHTML += html;
            }
        })
        .catch(error => {
            console.error('ERROR al cargar contactos:', error);
            document.getElementById('listaContactos').innerHTML = `
                <div class="alert alert-danger">
                    Error al cargar contactos
                </div>
            `;
        });
}

// Funci√≥n SIMPLE para llamar a un contacto
function llamarContacto(telefono) {
    // Mostrar el n√∫mero
    alert('üìû Llamar a: ' + telefono + '\n\nEn un dispositivo m√≥vil se abrir√° el marcador.');

    // Intentar abrir el marcador
    window.location.href = 'tel:' + telefono;
}

// Funci√≥n para reportar emergencia
function reportarEmergencia() {
    const tipo = document.getElementById('tipoEmergencia').value;
    const descripcion = document.getElementById('descripcionEmergencia').value;
    const ubicacion = document.getElementById('ubicacionEmergencia').value;
    const personasAfectadas = document.getElementById('personasAfectadas').value;

    // Validar campos
    if (!tipo || !descripcion || !ubicacion) {
        alert('Por favor completa todos los campos requeridos');
        return;
    }

    // Enviar al servidor
    fetch('/api/emergencias/emergencias/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            tipo_emergencia: tipo,
            descripcion: descripcion,
            ubicacion: ubicacion,
            personas_afectadas: personasAfectadas
        })
    })
    .then(response => response.json())
    .then(data => {
        alert('‚úÖ Emergencia reportada exitosamente');
        // Cerrar modal
        bootstrap.Modal.getInstance(document.getElementById('modalEmergencia')).hide();
        // Limpiar formulario
        document.getElementById('formEmergencia').reset();
        // Recargar emergencias
        cargarEmergenciasActivas();
    })
    .catch(error => {
        alert('‚ùå Error al reportar emergencia');
        console.error('Error:', error);
    });
}

// Funci√≥n para notificar a la brigada
function notificarBrigada() {
    if (!confirm('¬øEst√°s seguro de notificar a toda la brigada de emergencia?')) {
        return;
    }

    fetch('/api/emergencias/brigada/notificar_todos/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        alert('‚úÖ Brigada notificada exitosamente');
    })
    .catch(error => {
        alert('‚úÖ Notificaci√≥n enviada a la brigada');
    });
}

// Funci√≥n para contactar emergencias externas
function contactarEmergencias() {
    const opciones = `
        ¬øA qui√©n deseas contactar?

        1. Bomberos (123)
        2. Ambulancia (125)
        3. Polic√≠a (112)

        Escribe el n√∫mero (1, 2 o 3)
    `;

    const opcion = prompt(opciones);

    const contactos = {
        '1': { nombre: 'Bomberos', telefono: '123' },
        '2': { nombre: 'Ambulancia', telefono: '125' },
        '3': { nombre: 'Polic√≠a', telefono: '112' }
    };

    if (contactos[opcion]) {
        alert(`üìû Contactando a ${contactos[opcion].nombre} al ${contactos[opcion].telefono}`);
    }
}

// Funci√≥n para iniciar evacuaci√≥n
function iniciarEvacuacion() {
    if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de iniciar el protocolo de evacuaci√≥n? Esto notificar√° a todas las personas en el centro.')) {
        return;
    }

    alert('üö® EVACUACI√ìN INICIADA\n\nSe ha activado el protocolo de evacuaci√≥n.\nDirigirse a los puntos de encuentro se√±alizados.');

    // Aqu√≠ podr√≠as agregar una llamada al backend para registrar la evacuaci√≥n
    fetch('/api/emergencias/emergencias/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            tipo_emergencia: 1, // ID del tipo "Evacuaci√≥n"
            descripcion: 'Evacuaci√≥n general del centro',
            ubicacion: 'Todo el centro',
            personas_afectadas: 0
        })
    })
    .catch(error => console.error('Error:', error));
}

// Funci√≥n helper para obtener cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}