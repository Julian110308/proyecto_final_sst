{% extends 'base.html' %}
{% load static %}

{% block title %}Control de Acceso - SST Centro Minero{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Control de Acceso</li>
{% endblock %}

{% block extra_css %}
<style>
    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #6c757d;
    }

    .aforo-progress {
        height: 8px;
        border-radius: 10px;
    }


    .registro-badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .badge-dentro {
        background-color: #d4edda;
        color: #155724;
    }

    .badge-salio {
        background-color: #f8d7da;
        color: #721c24;
    }

    .alerta-aforo {
        animation: parpadeo 1.5s infinite;
    }

    @keyframes parpadeo {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold text-dark mb-1">
                <i class="bi bi-door-open text-primary-green me-2"></i>
                Control de Acceso
            </h1>
            <p class="text-muted">Gestión de ingresos y egresos del centro</p>
        </div>
        <div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalRegistroManual">
                <i class="bi bi-plus-circle me-2"></i>Registrar Acceso
            </button>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="row g-4 mb-4">
        <!-- Personas en Centro -->
        <div class="col-xl-3 col-md-6">
            <div class="card card-modern">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="stat-label mb-2">En Centro Ahora</h6>
                            <h3 class="stat-number mb-0" id="stat-personas-dentro">0</h3>
                            <small class="text-success">Personas activas</small>
                        </div>
                        <div class="bg-light-green rounded-3 p-3">
                            <i class="bi bi-people-fill fs-2 text-primary-green"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ingresos Hoy -->
        <div class="col-xl-3 col-md-6">
            <div class="card card-modern">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="stat-label mb-2">Ingresos Hoy</h6>
                            <h3 class="stat-number mb-0" id="stat-ingresos-hoy">0</h3>
                            <small class="text-success">Registros totales</small>
                        </div>
                        <div class="bg-light-green rounded-3 p-3">
                            <i class="bi bi-door-open fs-2 text-accent-green"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Visitantes Activos -->
        <div class="col-xl-3 col-md-6">
            <div class="card card-modern">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="stat-label mb-2">Visitantes Activos</h6>
                            <h3 class="stat-number mb-0" id="stat-visitantes">0</h3>
                            <small class="text-muted">Sin registrar salida</small>
                        </div>
                        <div style="background-color: #fff3cd;" class="rounded-3 p-3">
                            <i class="bi bi-person-badge fs-2 text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Capacidad/Aforo -->
        <div class="col-xl-3 col-md-6">
            <div class="card card-modern">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="stat-label mb-2">Capacidad</h6>
                            <h3 class="stat-number mb-0" id="stat-porcentaje-aforo">0%</h3>
                            <div class="progress aforo-progress mt-2">
                                <div class="progress-bar" id="aforo-bar" style="width: 0%"></div>
                            </div>
                            <small class="mt-1 d-block" id="stat-aforo-texto">Normal</small>
                        </div>
                        <div class="bg-light-green rounded-3 p-3">
                            <i class="bi bi-building fs-2 text-secondary-green"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerta de Aforo (se muestra solo si es necesario) -->
    <div class="alert alert-warning alerta-aforo d-none" id="alertaAforo" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong>Advertencia:</strong> <span id="mensajeAforo"></span>
    </div>

    <!-- Tabla de Registros -->
    <div class="row">
        <div class="col-12">
            <div class="card card-modern">
                <div class="card-header-modern d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-list-ul me-2"></i>
                        Registros de Acceso Recientes
                    </h6>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-light active" onclick="filtrarRegistros('todos')">Todos</button>
                        <button class="btn btn-outline-light" onclick="filtrarRegistros('dentro')">Dentro</button>
                        <button class="btn btn-outline-light" onclick="filtrarRegistros('salio')">Salieron</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="tablaRegistros">
                            <thead class="table-light">
                                <tr>
                                    <th>Usuario</th>
                                    <th>Rol</th>
                                    <th>Documento</th>
                                    <th>Hora Ingreso</th>
                                    <th>Hora Egreso</th>
                                    <th>Método</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="registrosBody">
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-5">
                                        <i class="bi bi-hourglass-split fs-1 mb-2 d-block"></i>
                                        Cargando registros...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Registro Manual -->
<div class="modal fade" id="modalRegistroManual" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary-green text-white">
                <h5 class="modal-title">
                    <i class="bi bi-person-plus me-2"></i>
                    Registro Manual de Acceso
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formRegistroManual">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Tipo de Registro *</label>
                        <select class="form-select" id="tipoRegistro" required>
                            <option value="">Seleccionar...</option>
                            <option value="ingreso">Ingreso</option>
                            <option value="egreso">Egreso</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Buscar Usuario *</label>
                        <input type="text" class="form-control" id="buscarUsuario"
                               placeholder="Buscar por nombre o documento...">
                        <select class="form-select mt-2" id="selectUsuario" required>
                            <option value="">Seleccionar usuario...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Método</label>
                        <select class="form-select" id="metodoRegistro">
                            <option value="MANUAL">Registro Manual</option>
                            <option value="AUTOMATICO">Detección Automática</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notas (opcional)</label>
                        <textarea class="form-control" id="notasRegistro" rows="2"
                                  placeholder="Agregar observaciones..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="registrarAccesoManual()">
                    <i class="bi bi-check-circle me-1"></i>Registrar
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let filtroActual = 'todos';
let todosLosUsuarios = []; // Array para guardar todos los usuarios

// Cargar datos al iniciar
document.addEventListener('DOMContentLoaded', function() {
    cargarEstadisticas();
    cargarRegistros();
    cargarUsuarios();

    // Actualizar cada 30 segundos
    setInterval(cargarEstadisticas, 30000);
    setInterval(cargarRegistros, 30000);

    // NUEVO: Filtrar cuando presionas ENTER en el campo de búsqueda
    const buscarUsuarioInput = document.getElementById('buscarUsuario');
    if (buscarUsuarioInput) {
        buscarUsuarioInput.addEventListener('keypress', function(event) {
            // Si presionas Enter
            if (event.key === 'Enter') {
                event.preventDefault(); // No enviar el formulario
                filtrarUsuarios();
            }
        });
    }
});

// Cargar estadísticas
async function cargarEstadisticas() {
    try {
        const response = await fetch('/api/acceso/registros/estadisticas/');
        const data = await response.json();

        // Actualizar estadísticas
        document.getElementById('stat-personas-dentro').textContent = data.personas_dentro;
        document.getElementById('stat-ingresos-hoy').textContent = data.ingresos_hoy;
        document.getElementById('stat-visitantes').textContent = data.visitantes_activos;

        // Actualizar aforo
        const aforo = data.aforo;
        document.getElementById('stat-porcentaje-aforo').textContent = aforo.porcentaje + '%';

        const aforoBar = document.getElementById('aforo-bar');
        aforoBar.style.width = aforo.porcentaje + '%';

        // Cambiar color según nivel
        aforoBar.classList.remove('bg-success', 'bg-warning', 'bg-danger');
        const alertaAforo = document.getElementById('alertaAforo');

        if (aforo.alerta === 'CRITICO') {
            aforoBar.classList.add('bg-danger');
            document.getElementById('stat-aforo-texto').textContent = 'Crítico';
            document.getElementById('stat-aforo-texto').className = 'mt-1 d-block text-danger';
            alertaAforo.classList.remove('d-none', 'alert-warning');
            alertaAforo.classList.add('alert-danger');
            document.getElementById('mensajeAforo').textContent = aforo.mensaje;
        } else if (aforo.alerta === 'ADVERTENCIA') {
            aforoBar.classList.add('bg-warning');
            document.getElementById('stat-aforo-texto').textContent = 'Advertencia';
            document.getElementById('stat-aforo-texto').className = 'mt-1 d-block text-warning';
            alertaAforo.classList.remove('d-none', 'alert-danger');
            alertaAforo.classList.add('alert-warning');
            document.getElementById('mensajeAforo').textContent = aforo.mensaje;
        } else {
            aforoBar.classList.add('bg-success');
            document.getElementById('stat-aforo-texto').textContent = 'Normal';
            document.getElementById('stat-aforo-texto').className = 'mt-1 d-block text-success';
            alertaAforo.classList.add('d-none');
        }

    } catch (error) {
        console.error('Error cargando estadísticas:', error);
    }
}

// Cargar registros recientes
async function cargarRegistros() {
    try {
        let url = '/api/acceso/registros/registros_recientes/?limite=50';

        if (filtroActual === 'dentro') {
            url += '&dentro=true';
        } else if (filtroActual === 'salio') {
            url += '&dentro=false';
        }

        const response = await fetch(url);
        const registros = await response.json();

        const tbody = document.getElementById('registrosBody');

        if (registros.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1 mb-2 d-block"></i>
                        No hay registros de acceso
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = registros.map(reg => {
            const fechaIngreso = new Date(reg.fecha_hora_ingreso);
            const horaIngreso = fechaIngreso.toLocaleTimeString('es-CO', {hour: '2-digit', minute: '2-digit'});

            let horaEgreso = '-';
            if (reg.fecha_hora_egreso) {
                const fechaEgreso = new Date(reg.fecha_hora_egreso);
                horaEgreso = fechaEgreso.toLocaleTimeString('es-CO', {hour: '2-digit', minute: '2-digit'});
            }

            const estadoBadge = reg.estado === 'DENTRO'
                ? '<span class="registro-badge badge-dentro">DENTRO</span>'
                : '<span class="registro-badge badge-salio">SALIÓ</span>';

            return `
                <tr>
                    <td>
                        <div class="fw-bold">${reg.usuario.nombre}</div>
                    </td>
                    <td>
                        <span class="badge bg-secondary">${reg.usuario.rol}</span>
                    </td>
                    <td><small>${reg.usuario.documento}</small></td>
                    <td>${horaIngreso}</td>
                    <td>${horaEgreso}</td>
                    <td><small>${reg.metodo_ingreso}</small></td>
                    <td>${estadoBadge}</td>
                </tr>
            `;
        }).join('');

    } catch (error) {
        console.error('Error cargando registros:', error);
    }
}

// Filtrar registros
function filtrarRegistros(filtro) {
    filtroActual = filtro;

    // Actualizar botones activos
    document.querySelectorAll('.btn-group-sm .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');

    cargarRegistros();
}

// Cargar usuarios para el select (CÓDIGO SIMPLE)
function cargarUsuarios() {
    console.log('Cargando usuarios...');

    fetch('/api/auth/usuarios/listar_para_acceso/', {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        console.log('Respuesta del servidor:', response.status);
        if (!response.ok) {
            throw new Error('Error ' + response.status);
        }
        return response.json();
    })
    .then(usuarios => {
        console.log('Usuarios recibidos:', usuarios.length);
        console.log('Primer usuario:', usuarios[0]);

        // Guardar para filtrar después
        todosLosUsuarios = usuarios;

        // Mostrar en el select
        renderizarUsuarios(usuarios);
    })
    .catch(error => {
        console.error('ERROR:', error);
        alert('❌ Error al cargar usuarios. Verifica que estés logueado con un usuario VIGILANCIA, ADMINISTRATIVO o INSTRUCTOR');

        const select = document.getElementById('selectUsuario');
        select.innerHTML = '<option value="">Error - Verifica tu sesión</option>';
    });
}

// Renderizar lista de usuarios en el select (CÓDIGO SIMPLE)
function renderizarUsuarios(usuarios) {
    const select = document.getElementById('selectUsuario');

    // GUARDAR el valor que estaba seleccionado antes
    const valorSeleccionado = select.value;

    // Limpiar el select
    select.innerHTML = '<option value="">Seleccionar usuario...</option>';

    // Diccionario de roles en español
    const roles = {
        'APRENDIZ': 'Aprendiz',
        'INSTRUCTOR': 'Instructor',
        'ADMINISTRATIVO': 'Administrativo',
        'VIGILANCIA': 'Vigilancia',
        'BRIGADA': 'Brigada',
        'VISITANTE': 'Visitante'
    };

    // Agregar cada usuario al select
    for (let i = 0; i < usuarios.length; i++) {
        const usuario = usuarios[i];

        // Construir el nombre completo
        let nombre = usuario.first_name + ' ' + usuario.last_name;
        if (nombre.trim() === '') {
            nombre = usuario.username;
        }

        // Obtener el rol en español
        const rol = roles[usuario.rol] || usuario.rol;

        // Crear la opción
        const opcion = document.createElement('option');
        opcion.value = usuario.id;
        opcion.textContent = nombre + ' - ' + rol + ' (' + usuario.numero_documento + ')';

        // Agregar al select
        select.appendChild(opcion);
    }

    // RESTAURAR el valor que estaba seleccionado
    if (valorSeleccionado) {
        select.value = valorSeleccionado;
    }

    console.log('Se agregaron ' + usuarios.length + ' usuarios al select');
}

// Filtrar usuarios según el texto de búsqueda (CÓDIGO SIMPLE)
function filtrarUsuarios() {
    const busqueda = document.getElementById('buscarUsuario').value.toLowerCase();

    // Si está vacío, mostrar todos
    if (busqueda === '') {
        renderizarUsuarios(todosLosUsuarios);
        return;
    }

    // Filtrar usuarios
    const filtrados = [];
    for (let i = 0; i < todosLosUsuarios.length; i++) {
        const usuario = todosLosUsuarios[i];

        // Buscar en nombre
        const nombre = (usuario.first_name + ' ' + usuario.last_name).toLowerCase();
        // Buscar en documento
        const documento = usuario.numero_documento.toLowerCase();
        // Buscar en username
        const username = usuario.username.toLowerCase();

        // Si encuentra en alguno, agregarlo
        if (nombre.includes(busqueda) || documento.includes(busqueda) || username.includes(busqueda)) {
            filtrados.push(usuario);
        }
    }

    console.log('Usuarios filtrados:', filtrados.length);
    renderizarUsuarios(filtrados);
}

// Registro manual
async function registrarAccesoManual() {
    const tipo = document.getElementById('tipoRegistro').value;
    const usuarioId = document.getElementById('selectUsuario').value;
    const metodo = document.getElementById('metodoRegistro').value;

    if (!tipo || !usuarioId) {
        alert('Por favor completa todos los campos requeridos');
        return;
    }

    try {
        const endpoint = tipo === 'ingreso' ? 'registrar_ingreso' : 'registrar_egreso';

        const response = await fetch(`/api/acceso/registros/${endpoint}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                usuario_id: parseInt(usuarioId),
                metodo: metodo
            })
        });

        const data = await response.json();

        if (data.success || data.mensaje) {
            alert(`✅ ${data.mensaje}`);
            bootstrap.Modal.getInstance(document.getElementById('modalRegistroManual')).hide();
            document.getElementById('formRegistroManual').reset();
            cargarEstadisticas();
            cargarRegistros();
        } else {
            alert(`❌ ${data.error}`);
        }
    } catch (error) {
        console.error('Error en registro:', error);
        alert('Error al registrar el acceso');
    }
}
</script>
{% endblock %}
