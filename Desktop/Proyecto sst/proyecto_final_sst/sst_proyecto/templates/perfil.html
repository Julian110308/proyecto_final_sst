{% extends 'base.html' %}
{% load static %}

{% block title %}Mi Perfil - SST Centro Minero{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Mi Perfil</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold text-dark mb-1">
                <i class="bi bi-person-circle text-primary-green me-2"></i>
                Mi Perfil
            </h1>
            <p class="text-muted">Informaci√≥n personal y configuraci√≥n de cuenta</p>
        </div>
        <button class="btn btn-primary" onclick="habilitarEdicion()">
            <i class="bi bi-pencil me-2"></i>Editar Perfil
        </button>
    </div>

    <div class="row g-4">
        <!-- Informaci√≥n Personal -->
        <div class="col-lg-4">
            <div class="card card-modern">
                <div class="card-body text-center">
                    <!-- Avatar -->
                    <div class="bg-primary-green rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
                         style="width: 120px; height: 120px;">
                        <i class="bi bi-person-fill text-white" style="font-size: 4rem;"></i>
                    </div>

                    <h4 class="fw-bold">{{ usuario.first_name }} {{ usuario.last_name }}</h4>
                    <p class="text-muted mb-3">@{{ usuario.username }}</p>

                    <span class="badge bg-info mb-3">{{ usuario.get_rol_display }}</span>

                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-outline-primary btn-sm" onclick="cambiarContrasena()">
                            <i class="bi bi-key me-1"></i>
                            Cambiar Contrase√±a
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="verHistorial()">
                            <i class="bi bi-clock-history me-1"></i>
                            Ver Historial de Acceso
                        </button>
                    </div>
                </div>
            </div>

            <!-- Estad√≠sticas R√°pidas -->
            <div class="card card-modern mt-3">
                <div class="card-header-modern">
                    <h6 class="mb-0">Estad√≠sticas</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">D√≠as en el sistema</span>
                        <span class="fw-bold" id="diasSistema">-</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">Ingresos este mes</span>
                        <span class="fw-bold" id="ingresosMes">-</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">√öltimo acceso</span>
                        <span class="fw-bold" id="ultimoAcceso">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detalles del Perfil -->
        <div class="col-lg-8">
            <div class="card card-modern mb-4">
                <div class="card-header-modern">
                    <h6 class="mb-0">Informaci√≥n Personal</h6>
                </div>
                <div class="card-body">
                    <form id="formPerfil">
                        {% csrf_token %}
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Nombres</label>
                                <input type="text" class="form-control" id="nombres"
                                       value="{{ usuario.first_name }}" disabled>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Apellidos</label>
                                <input type="text" class="form-control" id="apellidos"
                                       value="{{ usuario.last_name }}" disabled>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tipo de Documento</label>
                                <input type="text" class="form-control" id="tipoDocumento"
                                       value="{{ usuario.get_tipo_documento_display }}" disabled>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">N√∫mero de Documento</label>
                                <input type="text" class="form-control" id="numeroDocumento"
                                       value="{{ usuario.numero_documento }}" disabled>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="email"
                                       value="{{ usuario.email }}" disabled>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tel√©fono</label>
                                <input type="text" class="form-control" id="telefono"
                                       value="{{ usuario.telefono|default:'' }}" disabled>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Rol</label>
                                <input type="text" class="form-control"
                                       value="{{ usuario.get_rol_display }}" disabled>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Fecha de Registro</label>
                                <input type="text" class="form-control"
                                       value="{{ usuario.fecha_registro|date:'d/m/Y H:i' }}" disabled>
                            </div>
                        </div>

                        <div class="mt-4" id="botonesEdicion" style="display: none;">
                            <button type="button" class="btn btn-success me-2" onclick="guardarCambios()">
                                <i class="bi bi-check-circle me-1"></i>
                                Guardar Cambios
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="cancelarEdicion()">
                                <i class="bi bi-x-circle me-1"></i>
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Preferencias -->
            <div class="card card-modern">
                <div class="card-header-modern">
                    <h6 class="mb-0">Preferencias y Configuraci√≥n</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="notificacionesEmail" checked>
                            <label class="form-check-label" for="notificacionesEmail">
                                Recibir notificaciones por email
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="notificacionesApp" checked>
                            <label class="form-check-label" for="notificacionesApp">
                                Notificaciones en la aplicaci√≥n
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="ubicacionAuto">
                            <label class="form-check-label" for="ubicacionAuto">
                                Activar ubicaci√≥n autom√°tica
                            </label>
                        </div>
                    </div>

                    <button class="btn btn-primary btn-sm mt-3" onclick="guardarPreferencias()">
                        <i class="bi bi-check-circle me-1"></i>
                        Guardar Preferencias
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Cambiar Contrase√±a -->
<div class="modal fade" id="modalCambiarContrasena" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary-green text-white">
                <h5 class="modal-title">
                    <i class="bi bi-key me-2"></i>
                    Cambiar Contrase√±a
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formCambiarContrasena">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Contrase√±a Actual</label>
                        <input type="password" class="form-control" id="contrasenaActual" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nueva Contrase√±a</label>
                        <input type="password" class="form-control" id="contrasenaNueva" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Confirmar Nueva Contrase√±a</label>
                        <input type="password" class="form-control" id="contrasenaConfirmar" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="procesarCambioContrasena()">
                    <i class="bi bi-check-circle me-1"></i>
                    Cambiar Contrase√±a
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Calcular d√≠as en el sistema
document.addEventListener('DOMContentLoaded', function() {
    calcularEstadisticas();
});

function calcularEstadisticas() {
    const fechaRegistro = new Date('{{ usuario.fecha_registro|date:"Y-m-d" }}');
    const hoy = new Date();
    const diasSistema = Math.floor((hoy - fechaRegistro) / (1000 * 60 * 60 * 24));

    document.getElementById('diasSistema').textContent = diasSistema + ' d√≠as';
    document.getElementById('ingresosMes').textContent = '0'; // Se cargar√≠a del backend
    document.getElementById('ultimoAcceso').textContent = 'Hoy'; // Se cargar√≠a del backend
}

// Habilitar edici√≥n
function habilitarEdicion() {
    document.getElementById('nombres').disabled = false;
    document.getElementById('apellidos').disabled = false;
    document.getElementById('email').disabled = false;
    document.getElementById('telefono').disabled = false;
    document.getElementById('botonesEdicion').style.display = 'block';
}

// Cancelar edici√≥n
function cancelarEdicion() {
    document.getElementById('nombres').disabled = true;
    document.getElementById('apellidos').disabled = true;
    document.getElementById('email').disabled = true;
    document.getElementById('telefono').disabled = true;
    document.getElementById('botonesEdicion').style.display = 'none';
    location.reload(); // Recargar para restaurar valores originales
}

// Guardar cambios
function guardarCambios() {
    const nombres = document.getElementById('nombres').value;
    const apellidos = document.getElementById('apellidos').value;
    const email = document.getElementById('email').value;
    const telefono = document.getElementById('telefono').value;

    if (!nombres || !apellidos || !email) {
        alert('Por favor completa los campos requeridos');
        return;
    }

    alert('‚úÖ Perfil actualizado exitosamente');
    cancelarEdicion();

    // Aqu√≠ llamar√≠as al backend para guardar
    // fetch('/api/auth/usuarios/perfil/', {
    //     method: 'PATCH',
    //     headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
    //     body: JSON.stringify({first_name: nombres, last_name: apellidos, email: email, telefono: telefono})
    // });
}

// Guardar preferencias
function guardarPreferencias() {
    alert('‚úÖ Preferencias guardadas exitosamente');
}

// Cambiar contrase√±a
function cambiarContrasena() {
    const modal = new bootstrap.Modal(document.getElementById('modalCambiarContrasena'));
    modal.show();
}

// Procesar cambio de contrase√±a
function procesarCambioContrasena() {
    const actual = document.getElementById('contrasenaActual').value;
    const nueva = document.getElementById('contrasenaNueva').value;
    const confirmar = document.getElementById('contrasenaConfirmar').value;

    if (!actual || !nueva || !confirmar) {
        alert('Por favor completa todos los campos');
        return;
    }

    if (nueva !== confirmar) {
        alert('Las contrase√±as no coinciden');
        return;
    }

    if (nueva.length < 8) {
        alert('La contrase√±a debe tener al menos 8 caracteres');
        return;
    }

    alert('‚úÖ Contrase√±a cambiada exitosamente');
    bootstrap.Modal.getInstance(document.getElementById('modalCambiarContrasena')).hide();
    document.getElementById('formCambiarContrasena').reset();

    // Aqu√≠ llamar√≠as al backend
    // fetch('/api/auth/usuarios/cambiar-contrasena/', {
    //     method: 'POST',
    //     headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
    //     body: JSON.stringify({old_password: actual, new_password: nueva})
    // });
}

// Ver historial
function verHistorial() {
    alert('üìã Historial de acceso\n\nEsta funci√≥n mostrar√≠a los √∫ltimos 10 accesos al sistema');
}
</script>
{% endblock %}
