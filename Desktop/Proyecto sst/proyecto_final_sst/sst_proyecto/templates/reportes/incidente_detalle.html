{% extends 'base.html' %}

{% block title %}{{ incidente.titulo }} - Sistema SST{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'listar_incidentes' %}">Incidentes</a></li>
<li class="breadcrumb-item active">{{ incidente.titulo }}</li>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 fw-bold text-dark mb-1">
            <i class="bi bi-file-text-fill text-warning me-2"></i>
            {{ incidente.titulo }}
        </h1>
        <p class="text-muted mb-0">Detalles del incidente reportado</p>
    </div>
    <div>
        {% if user.rol == 'ADMINISTRATIVO' %}
        <a href="{% url 'actualizar_incidente' incidente.pk %}" class="btn btn-primary">
            <i class="bi bi-pencil-square me-1"></i>
            Actualizar Estado
        </a>
        {% endif %}
        <a href="{% url 'listar_incidentes' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left me-1"></i>
            Volver
        </a>
    </div>
</div>

<!-- Información Principal -->
<div class="row g-4 mb-4">
    <!-- Información Básica -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Información del Incidente
                </h5>
            </div>
            <div class="card-body">
                <!-- Descripción -->
                <div class="mb-4">
                    <h6 class="text-muted mb-2">Descripción</h6>
                    <p class="mb-0">{{ incidente.descripcion }}</p>
                </div>

                <!-- Ubicación -->
                {% if incidente.ubicacion %}
                <div class="mb-4">
                    <h6 class="text-muted mb-2">
                        <i class="bi bi-geo-alt me-1"></i>
                        Ubicación
                    </h6>
                    <p class="mb-0">{{ incidente.ubicacion }}</p>
                </div>
                {% endif %}

                <!-- Foto -->
                {% if incidente.foto %}
                <div class="mb-4">
                    <h6 class="text-muted mb-2">
                        <i class="bi bi-camera me-1"></i>
                        Evidencia Fotográfica
                    </h6>
                    <img src="{{ incidente.foto.url }}" alt="Evidencia" class="img-fluid rounded" style="max-height: 400px;">
                </div>
                {% endif %}

                <!-- Acciones Tomadas -->
                {% if incidente.acciones_tomadas %}
                <div class="mb-0">
                    <h6 class="text-muted mb-2">
                        <i class="bi bi-clipboard-check me-1"></i>
                        Acciones Tomadas
                    </h6>
                    <p class="mb-0">{{ incidente.acciones_tomadas }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Panel Lateral -->
    <div class="col-lg-4">
        <!-- Estado -->
        <div class="card mb-3">
            <div class="card-body">
                <h6 class="text-muted mb-3">Estado del Incidente</h6>

                {% if incidente.estado == 'REPORTADO' %}
                <span class="badge bg-warning fs-6 mb-3">{{ incidente.get_estado_display }}</span>
                {% elif incidente.estado == 'EN_REVISION' or incidente.estado == 'EN_PROCESO' %}
                <span class="badge bg-info fs-6 mb-3">{{ incidente.get_estado_display }}</span>
                {% else %}
                <span class="badge bg-success fs-6 mb-3">{{ incidente.get_estado_display }}</span>
                {% endif %}

                <hr>

                <!-- Tipo -->
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Tipo</small>
                    <span class="badge bg-secondary">{{ incidente.get_tipo_display }}</span>
                </div>

                <!-- Gravedad -->
                <div class="mb-0">
                    <small class="text-muted d-block mb-1">Gravedad</small>
                    {% if incidente.gravedad == 'CRITICA' %}
                    <span class="badge bg-danger">Crítica</span>
                    {% elif incidente.gravedad == 'ALTA' %}
                    <span class="badge bg-warning">Alta</span>
                    {% elif incidente.gravedad == 'MEDIA' %}
                    <span class="badge bg-info">Media</span>
                    {% else %}
                    <span class="badge bg-secondary">Baja</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Fechas -->
        <div class="card mb-3">
            <div class="card-body">
                <h6 class="text-muted mb-3">Fechas Importantes</h6>

                <div class="mb-3">
                    <small class="text-muted d-block mb-1">
                        <i class="bi bi-calendar-event me-1"></i>
                        Fecha del Incidente
                    </small>
                    <strong>{{ incidente.fecha_incidente|date:"d/m/Y H:i" }}</strong>
                </div>

                <div class="mb-3">
                    <small class="text-muted d-block mb-1">
                        <i class="bi bi-clock me-1"></i>
                        Fecha de Reporte
                    </small>
                    <strong>{{ incidente.fecha_reporte|date:"d/m/Y H:i" }}</strong>
                </div>

                {% if incidente.fecha_resolucion %}
                <div class="mb-0">
                    <small class="text-muted d-block mb-1">
                        <i class="bi bi-check-circle me-1"></i>
                        Fecha de Resolución
                    </small>
                    <strong>{{ incidente.fecha_resolucion|date:"d/m/Y H:i" }}</strong>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Responsables -->
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted mb-3">Responsables</h6>

                <div class="mb-3">
                    <small class="text-muted d-block mb-1">
                        <i class="bi bi-person me-1"></i>
                        Reportado por
                    </small>
                    <strong>{{ incidente.reportado_por.get_full_name|default:incidente.reportado_por.username }}</strong>
                    <br>
                    <small class="text-muted">{{ incidente.reportado_por.get_rol_display }}</small>
                </div>

                {% if incidente.asignado_a %}
                <div class="mb-0">
                    <small class="text-muted d-block mb-1">
                        <i class="bi bi-person-check me-1"></i>
                        Asignado a
                    </small>
                    <strong>{{ incidente.asignado_a.get_full_name|default:incidente.asignado_a.username }}</strong>
                    <br>
                    <small class="text-muted">{{ incidente.asignado_a.get_rol_display }}</small>
                </div>
                {% else %}
                <div class="mb-0">
                    <small class="text-muted d-block mb-1">
                        <i class="bi bi-person-check me-1"></i>
                        Asignado a
                    </small>
                    <span class="text-muted fst-italic">Sin asignar</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
